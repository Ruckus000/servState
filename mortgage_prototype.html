<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ServState | Premium Mortgage Servicing</title>
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.development.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Plus Jakarta Sans', 'system-ui', 'sans-serif'],
            },
            colors: {
              border: 'hsl(var(--border))',
              input: 'hsl(var(--input))',
              ring: 'hsl(var(--ring))',
              background: 'hsl(var(--background))',
              foreground: 'hsl(var(--foreground))',
              primary: {
                DEFAULT: 'hsl(var(--primary))',
                foreground: 'hsl(var(--primary-foreground))',
              },
              secondary: {
                DEFAULT: 'hsl(var(--secondary))',
                foreground: 'hsl(var(--secondary-foreground))',
              },
              destructive: {
                DEFAULT: 'hsl(var(--destructive))',
                foreground: 'hsl(var(--destructive-foreground))',
              },
              muted: {
                DEFAULT: 'hsl(var(--muted))',
                foreground: 'hsl(var(--muted-foreground))',
              },
              accent: {
                DEFAULT: 'hsl(var(--accent))',
                foreground: 'hsl(var(--accent-foreground))',
              },
              card: {
                DEFAULT: 'hsl(var(--card))',
                foreground: 'hsl(var(--card-foreground))',
              },
              success: {
                DEFAULT: 'hsl(var(--success))',
                foreground: 'hsl(var(--success-foreground))',
              },
              warning: {
                DEFAULT: 'hsl(var(--warning))',
                foreground: 'hsl(var(--warning-foreground))',
              },
            },
            borderRadius: {
              lg: 'var(--radius)',
              md: 'calc(var(--radius) - 2px)',
              sm: 'calc(var(--radius) - 4px)',
            },
            keyframes: {
              'accordion-down': {
                from: { height: '0' },
                to: { height: 'var(--radix-accordion-content-height)' },
              },
              'accordion-up': {
                from: { height: 'var(--radix-accordion-content-height)' },
                to: { height: '0' },
              },
              'slide-in-right': {
                from: { transform: 'translateX(100%)' },
                to: { transform: 'translateX(0)' },
              },
              'slide-out-right': {
                from: { transform: 'translateX(0)' },
                to: { transform: 'translateX(100%)' },
              },
              'fade-in': { from: { opacity: '0' }, to: { opacity: '1' } },
              'fade-up': {
                from: { opacity: '0', transform: 'translateY(10px)' },
                to: { opacity: '1', transform: 'translateY(0)' },
              },
              'scale-in': {
                from: { opacity: '0', transform: 'scale(0.95)' },
                to: { opacity: '1', transform: 'scale(1)' },
              },
              'spin-slow': {
                from: { transform: 'rotate(0deg)' },
                to: { transform: 'rotate(360deg)' },
              },
              'pulse-subtle': {
                '0%, 100%': { opacity: '1' },
                '50%': { opacity: '0.7' },
              },
              'count-up': {
                from: { '--num': '0' },
                to: { '--num': 'var(--target)' },
              },
            },
            animation: {
              'accordion-down': 'accordion-down 0.2s ease-out',
              'accordion-up': 'accordion-up 0.2s ease-out',
              'slide-in-right': 'slide-in-right 0.3s ease-out',
              'slide-out-right': 'slide-out-right 0.3s ease-out',
              'fade-in': 'fade-in 0.2s ease-out',
              'fade-up': 'fade-up 0.4s ease-out',
              'scale-in': 'scale-in 0.2s ease-out',
              'spin-slow': 'spin-slow 3s linear infinite',
              'pulse-subtle': 'pulse-subtle 2s ease-in-out infinite',
            },
          },
        },
      }
    </script>
    <style>
      :root {
        --background: 40 20% 98%;
        --foreground: 220 20% 10%;
        --card: 0 0% 100%;
        --card-foreground: 220 20% 10%;
        --primary: 168 76% 36%;
        --primary-foreground: 0 0% 100%;
        --secondary: 220 14% 96%;
        --secondary-foreground: 220 20% 20%;
        --muted: 220 14% 96%;
        --muted-foreground: 220 10% 46%;
        --accent: 36 100% 50%;
        --accent-foreground: 220 20% 10%;
        --destructive: 0 84% 60%;
        --destructive-foreground: 0 0% 100%;
        --success: 142 76% 36%;
        --success-foreground: 0 0% 100%;
        --warning: 38 92% 50%;
        --warning-foreground: 0 0% 100%;
        --border: 220 13% 91%;
        --input: 220 13% 91%;
        --ring: 168 76% 36%;
        --radius: 0.75rem;
      }
      .dark {
        --background: 220 20% 7%;
        --foreground: 220 14% 96%;
        --card: 220 20% 10%;
        --card-foreground: 220 14% 96%;
        --primary: 168 76% 42%;
        --primary-foreground: 0 0% 100%;
        --secondary: 220 14% 15%;
        --secondary-foreground: 220 14% 90%;
        --muted: 220 14% 15%;
        --muted-foreground: 220 10% 55%;
        --accent: 36 100% 50%;
        --accent-foreground: 0 0% 100%;
        --destructive: 0 62% 50%;
        --destructive-foreground: 0 0% 100%;
        --success: 142 70% 45%;
        --success-foreground: 0 0% 100%;
        --warning: 38 92% 50%;
        --warning-foreground: 0 0% 100%;
        --border: 220 13% 20%;
        --input: 220 13% 20%;
        --ring: 168 76% 42%;
      }
      * {
        border-color: hsl(var(--border));
      }
      body {
        font-family: 'Plus Jakarta Sans', system-ui, sans-serif;
        background: hsl(var(--background));
        color: hsl(var(--foreground));
      }
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: hsl(var(--muted-foreground) / 0.3);
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: hsl(var(--muted-foreground) / 0.5);
      }
      @keyframes fade-up {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .animate-in {
        animation: fade-up 0.4s ease-out both;
      }
      .stagger-1 {
        animation-delay: 0.05s;
      }
      .stagger-2 {
        animation-delay: 0.1s;
      }
      .stagger-3 {
        animation-delay: 0.15s;
      }
      .stagger-4 {
        animation-delay: 0.2s;
      }
      .glass {
        backdrop-filter: blur(12px);
        background: hsl(var(--card) / 0.8);
      }
      .gradient-border {
        background: linear-gradient(hsl(var(--card)), hsl(var(--card)))
            padding-box,
          linear-gradient(135deg, hsl(var(--primary)), hsl(var(--accent)))
            border-box;
        border: 2px solid transparent;
      }
      @keyframes shimmer {
        0% {
          background-position: -200% 0;
        }
        100% {
          background-position: 200% 0;
        }
      }
      .skeleton {
        background: linear-gradient(
          90deg,
          hsl(var(--muted)) 25%,
          hsl(var(--muted-foreground) / 0.1) 50%,
          hsl(var(--muted)) 75%
        );
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
      }
      .btn-glow {
        box-shadow: 0 0 20px hsl(var(--primary) / 0.4);
      }
      .btn-glow:hover {
        box-shadow: 0 0 30px hsl(var(--primary) / 0.6);
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const {
        useState,
        useEffect,
        useMemo,
        useCallback,
        createContext,
        useContext,
      } = React

      // ============ MOCK DATA ============
      const mockLoans = [
        {
          id: 'loan_1',
          borrower_name: 'James Anderson',
          address: '123 Maple Avenue, Springfield, IL 62704',
          loan_number: '10005678',
          loan_type: 'Conventional',
          original_principal: 350000,
          current_principal: 342100.5,
          interest_rate: 0.065,
          monthly_pi: 2212.24,
          monthly_escrow: 550.0,
          next_due_date: '2024-01-01',
          escrow_balance: 2400.0,
          status: 'Active',
          email: 'j.anderson@example.com',
          phone: '(555) 123-4567',
          origination_date: '2022-06-15',
          term_months: 360,
          payments_made: 18,
        },
        {
          id: 'loan_2',
          borrower_name: 'Sarah Jenkins',
          address: '456 Oak Lane, Shelbyville, IL 62565',
          loan_number: '10009921',
          loan_type: 'FHA',
          original_principal: 280000,
          current_principal: 275400.0,
          interest_rate: 0.058,
          monthly_pi: 1643.12,
          monthly_escrow: 420.0,
          next_due_date: '2024-01-01',
          escrow_balance: 1850.0,
          status: 'Active',
          email: 's.jenkins@example.com',
          phone: '(555) 987-6543',
          origination_date: '2023-02-01',
          term_months: 360,
          payments_made: 10,
        },
        {
          id: 'loan_3',
          borrower_name: 'Robert Vance',
          address: '789 Pine Street, Capital City, IL 62701',
          loan_number: '10001122',
          loan_type: 'VA',
          original_principal: 450000,
          current_principal: 448000.0,
          interest_rate: 0.072,
          monthly_pi: 3054.15,
          monthly_escrow: 680.0,
          next_due_date: '2023-11-01',
          escrow_balance: 1200.0,
          status: 'Delinquent',
          days_past_due: 45,
          email: 'bob.vance@example.com',
          phone: '(555) 555-0199',
          origination_date: '2023-08-01',
          term_months: 360,
          payments_made: 3,
        },
        {
          id: 'loan_4',
          borrower_name: 'Maria Garcia',
          address: '321 Elm Court, Riverside, IL 60546',
          loan_number: '10003344',
          loan_type: 'Conventional',
          original_principal: 520000,
          current_principal: 498500.0,
          interest_rate: 0.0625,
          monthly_pi: 3201.45,
          monthly_escrow: 720.0,
          next_due_date: '2024-01-01',
          escrow_balance: 3100.0,
          status: 'Active',
          email: 'm.garcia@example.com',
          phone: '(555) 234-5678',
          origination_date: '2021-09-01',
          term_months: 360,
          payments_made: 27,
        },
        {
          id: 'loan_5',
          borrower_name: 'David Kim',
          address: '567 Birch Road, Lakewood, IL 60014',
          loan_number: '10007788',
          loan_type: 'FHA',
          original_principal: 195000,
          current_principal: 188200.0,
          interest_rate: 0.055,
          monthly_pi: 1107.55,
          monthly_escrow: 310.0,
          next_due_date: '2023-12-01',
          escrow_balance: 890.0,
          status: 'Delinquent',
          days_past_due: 15,
          email: 'd.kim@example.com',
          phone: '(555) 345-6789',
          origination_date: '2022-12-01',
          term_months: 360,
          payments_made: 11,
        },
      ]

      const mockTransactions = [
        {
          id: 'tx_1',
          loan_id: 'loan_1',
          date: '2023-10-01',
          type: 'Payment',
          amount: 2762.24,
          breakdown: { principal: 400, interest: 1812.24, escrow: 550 },
          status: 'completed',
        },
        {
          id: 'tx_2',
          loan_id: 'loan_1',
          date: '2023-11-01',
          type: 'Payment',
          amount: 2762.24,
          breakdown: { principal: 402.15, interest: 1810.09, escrow: 550 },
          status: 'completed',
        },
        {
          id: 'tx_3',
          loan_id: 'loan_1',
          date: '2023-12-01',
          type: 'Payment',
          amount: 2762.24,
          breakdown: { principal: 404.32, interest: 1807.92, escrow: 550 },
          status: 'completed',
        },
        {
          id: 'tx_4',
          loan_id: 'loan_2',
          date: '2023-11-01',
          type: 'Payment',
          amount: 2063.12,
          breakdown: { principal: 320, interest: 1323.12, escrow: 420 },
          status: 'completed',
        },
        {
          id: 'tx_5',
          loan_id: 'loan_4',
          date: '2023-11-01',
          type: 'Payment',
          amount: 3921.45,
          breakdown: { principal: 580, interest: 2621.45, escrow: 720 },
          status: 'completed',
        },
      ]

      const mockDocuments = [
        {
          id: 'doc_1',
          loan_id: 'loan_1',
          name: 'Monthly Statement - Nov 2023',
          date: '2023-11-05',
          type: 'Statement',
          size: '245 KB',
        },
        {
          id: 'doc_2',
          loan_id: 'loan_1',
          name: 'Monthly Statement - Oct 2023',
          date: '2023-10-05',
          type: 'Statement',
          size: '242 KB',
        },
        {
          id: 'doc_3',
          loan_id: 'loan_1',
          name: 'Annual Escrow Disclosure',
          date: '2023-01-15',
          type: 'Disclosure',
          size: '1.2 MB',
        },
        {
          id: 'doc_4',
          loan_id: 'loan_1',
          name: 'Welcome Packet',
          date: '2022-06-20',
          type: 'Correspondence',
          size: '3.4 MB',
        },
        {
          id: 'doc_5',
          loan_id: 'loan_1',
          name: '1098 Tax Form - 2022',
          date: '2023-01-31',
          type: 'Tax',
          size: '89 KB',
        },
      ]

      const mockNotes = [
        {
          id: 'note_1',
          loan_id: 'loan_3',
          author: 'John Smith',
          date: '2023-11-15 14:30',
          content: 'Called borrower regarding missed payment. Left voicemail.',
          type: 'Call',
        },
        {
          id: 'note_2',
          loan_id: 'loan_3',
          author: 'John Smith',
          date: '2023-11-18 09:15',
          content:
            'Borrower returned call. Stated temporary job loss. Discussing payment plan options.',
          type: 'Call',
        },
        {
          id: 'note_3',
          loan_id: 'loan_3',
          author: 'Sarah Lee',
          date: '2023-11-20 11:00',
          content: 'Sent forbearance application packet via email.',
          type: 'Email',
        },
      ]

      const mockMessages = [
        {
          id: 'msg_1',
          loan_id: 'loan_1',
          from: 'borrower',
          date: '2023-11-25 10:30',
          content: 'When will I receive my annual escrow statement?',
          status: 'resolved',
        },
        {
          id: 'msg_2',
          loan_id: 'loan_1',
          from: 'servicer',
          date: '2023-11-25 14:15',
          content:
            'Your annual escrow analysis will be mailed by January 15th. You can also view it in your Documents section once available.',
          status: 'resolved',
        },
      ]

      const mockTasks = [
        {
          id: 'task_1',
          loan_id: 'loan_3',
          borrower_name: 'Robert Vance',
          loan_number: '10001122',
          type: 'collections_call',
          priority: 'high',
          status: 'pending',
          assigned_to: 'Collections Team',
          created_date: '2023-11-15',
          due_date: '2023-12-01',
          title: 'Collections Call - 45 Days Past Due',
          description: 'Follow up on missed payments. Borrower stated temporary job loss on last contact. Discuss payment plan options.',
          category: 'Collections',
        },
        {
          id: 'task_2',
          loan_id: 'loan_5',
          borrower_name: 'David Kim',
          loan_number: '10007788',
          type: 'document_request',
          priority: 'medium',
          status: 'in_progress',
          assigned_to: 'Sarah Lee',
          created_date: '2023-11-18',
          due_date: '2023-11-30',
          title: 'Request Income Documentation',
          description: 'Borrower requested forbearance. Need updated income verification (pay stubs, tax returns) to process application.',
          category: 'Loss Mitigation',
        },
        {
          id: 'task_3',
          loan_id: 'loan_1',
          borrower_name: 'James Anderson',
          loan_number: '10005678',
          type: 'escrow_analysis',
          priority: 'low',
          status: 'pending',
          assigned_to: 'Admin User',
          created_date: '2023-11-01',
          due_date: '2024-01-15',
          title: 'Annual Escrow Analysis',
          description: 'Perform annual escrow analysis and mail disclosure statement. Review property tax and insurance projections.',
          category: 'Escrow Management',
        },
        {
          id: 'task_4',
          loan_id: 'loan_2',
          borrower_name: 'Sarah Jenkins',
          loan_number: '10009921',
          type: 'statement_generation',
          priority: 'medium',
          status: 'pending',
          assigned_to: 'Admin User',
          created_date: '2023-11-28',
          due_date: '2023-12-05',
          title: 'Generate Monthly Statement - December',
          description: 'Generate and mail monthly statement for December billing cycle.',
          category: 'Reporting',
        },
        {
          id: 'task_5',
          loan_id: 'loan_3',
          borrower_name: 'Robert Vance',
          loan_number: '10001122',
          type: 'payment_plan',
          priority: 'high',
          status: 'completed',
          assigned_to: 'John Smith',
          created_date: '2023-11-10',
          due_date: '2023-11-22',
          completed_date: '2023-11-22',
          title: 'Set Up Repayment Plan',
          description: 'Establish 6-month repayment plan for $7,468.30 arrearage.',
          category: 'Loss Mitigation',
        },
        {
          id: 'task_6',
          loan_id: 'loan_4',
          borrower_name: 'Maria Garcia',
          loan_number: '10003344',
          type: 'property_inspection',
          priority: 'medium',
          status: 'pending',
          assigned_to: 'Property Team',
          created_date: '2023-11-20',
          due_date: '2023-12-15',
          title: 'Property Inspection',
          description: 'Schedule annual property inspection to verify occupancy and condition.',
          category: 'Property Management',
        },
        {
          id: 'task_7',
          loan_id: 'loan_1',
          borrower_name: 'James Anderson',
          loan_number: '10005678',
          type: 'tax_payment',
          priority: 'high',
          status: 'pending',
          assigned_to: 'Escrow Team',
          created_date: '2023-11-25',
          due_date: '2023-12-10',
          title: 'Property Tax Payment Due',
          description: 'Second installment of property taxes due. Verify escrow balance and process disbursement.',
          category: 'Escrow Management',
        },
        {
          id: 'task_8',
          loan_id: 'loan_2',
          borrower_name: 'Sarah Jenkins',
          loan_number: '10009921',
          type: 'insurance_verification',
          priority: 'medium',
          status: 'in_progress',
          assigned_to: 'Insurance Team',
          created_date: '2023-11-12',
          due_date: '2023-12-01',
          title: 'Verify Hazard Insurance Renewal',
          description: 'Insurance policy expires 12/31/2023. Contact borrower for renewal documentation.',
          category: 'Insurance',
        },
        {
          id: 'task_9',
          loan_id: 'loan_5',
          borrower_name: 'David Kim',
          loan_number: '10007788',
          type: 'collections_call',
          priority: 'high',
          status: 'pending',
          assigned_to: 'Collections Team',
          created_date: '2023-11-22',
          due_date: '2023-11-29',
          title: 'Collections Call - 30 Days Past Due',
          description: 'First delinquency notice sent. Follow up call required to discuss payment status.',
          category: 'Collections',
        },
        {
          id: 'task_10',
          loan_id: 'loan_3',
          borrower_name: 'Robert Vance',
          loan_number: '10001122',
          type: 'document_request',
          priority: 'high',
          status: 'in_progress',
          assigned_to: 'Sarah Lee',
          created_date: '2023-11-23',
          due_date: '2023-12-02',
          title: 'Send Payment Plan Agreement',
          description: 'Mail formal payment plan agreement for signature. Track receipt and return.',
          category: 'Loss Mitigation',
        },
        {
          id: 'task_11',
          loan_id: 'loan_4',
          borrower_name: 'Maria Garcia',
          loan_number: '10003344',
          type: 'statement_generation',
          priority: 'low',
          status: 'completed',
          assigned_to: 'Admin User',
          created_date: '2023-11-01',
          due_date: '2023-11-05',
          completed_date: '2023-11-04',
          title: 'Generate Year-End Tax Statement',
          description: 'Generate 1098 mortgage interest statement for tax year.',
          category: 'Reporting',
        },
        {
          id: 'task_12',
          loan_id: 'loan_1',
          borrower_name: 'James Anderson',
          loan_number: '10005678',
          type: 'customer_inquiry',
          priority: 'low',
          status: 'completed',
          assigned_to: 'Customer Service',
          created_date: '2023-11-25',
          due_date: '2023-11-26',
          completed_date: '2023-11-25',
          title: 'Respond to Escrow Inquiry',
          description: 'Answer borrower question about escrow statement timeline.',
          category: 'Customer Service',
        },
        {
          id: 'task_13',
          loan_id: 'loan_2',
          borrower_name: 'Sarah Jenkins',
          loan_number: '10009921',
          type: 'escrow_analysis',
          priority: 'medium',
          status: 'pending',
          assigned_to: 'Escrow Team',
          created_date: '2023-11-15',
          due_date: '2023-12-20',
          title: 'Escrow Shortage Analysis',
          description: 'Property tax assessment increased. Review escrow account for potential shortage.',
          category: 'Escrow Management',
        },
        {
          id: 'task_14',
          loan_id: 'loan_4',
          borrower_name: 'Maria Garcia',
          loan_number: '10003344',
          type: 'autopay_setup',
          priority: 'low',
          status: 'pending',
          assigned_to: 'Payment Team',
          created_date: '2023-11-27',
          due_date: '2023-12-10',
          title: 'Set Up Automatic Payment',
          description: 'Borrower requested AutoPay enrollment. Verify bank account and set up recurring payment.',
          category: 'Payment Processing',
        },
        {
          id: 'task_15',
          loan_id: 'loan_5',
          borrower_name: 'David Kim',
          loan_number: '10007788',
          type: 'payment_plan',
          priority: 'high',
          status: 'pending',
          assigned_to: 'John Smith',
          created_date: '2023-11-26',
          due_date: '2023-12-05',
          title: 'Evaluate Forbearance Request',
          description: 'Review forbearance application and supporting documentation. Determine eligibility.',
          category: 'Loss Mitigation',
        },
        {
          id: 'task_16',
          loan_id: 'loan_1',
          borrower_name: 'James Anderson',
          loan_number: '10005678',
          type: 'compliance_review',
          priority: 'medium',
          status: 'pending',
          assigned_to: 'Compliance Team',
          created_date: '2023-11-20',
          due_date: '2023-12-15',
          title: 'Annual Compliance Review',
          description: 'Conduct annual loan file review for regulatory compliance.',
          category: 'Compliance',
        },
        {
          id: 'task_17',
          loan_id: 'loan_3',
          borrower_name: 'Robert Vance',
          loan_number: '10001122',
          type: 'collections_call',
          priority: 'high',
          status: 'completed',
          assigned_to: 'Collections Team',
          created_date: '2023-11-08',
          due_date: '2023-11-15',
          completed_date: '2023-11-14',
          title: 'Initial Delinquency Contact',
          description: 'First contact regarding missed payment. Discussed hardship situation.',
          category: 'Collections',
        },
        {
          id: 'task_18',
          loan_id: 'loan_2',
          borrower_name: 'Sarah Jenkins',
          loan_number: '10009921',
          type: 'insurance_claim',
          priority: 'low',
          status: 'pending',
          assigned_to: 'Insurance Team',
          created_date: '2023-11-18',
          due_date: '2023-12-30',
          title: 'Process Insurance Renewal',
          description: 'Review and process hazard insurance renewal documentation.',
          category: 'Insurance',
        },
      ]

      const mockCorrespondence = [
        {
          id: 'corr_1',
          loan_id: 'loan_3',
          type: 'email',
          direction: 'outbound',
          subject: 'Missed Payment Notification',
          from: 'servicing@servstate.com',
          to: 'bob.vance@example.com',
          date: '2023-11-16 10:30:00',
          body: 'Dear Mr. Vance,\n\nWe have not yet received your mortgage payment that was due on November 1st, 2023. Your account is now 15 days past due.\n\nCurrent Amount Due: $3,734.15\nLate Fee: $75.00\nTotal Amount Due: $3,809.15\n\nPlease contact us immediately at 1-800-555-0199 to discuss payment options.\n\nSincerely,\nServState Servicing',
          status: 'opened',
          delivery_status: {
            sent: '2023-11-16 10:30:15',
            delivered: '2023-11-16 10:30:45',
            opened: '2023-11-16 14:22:10',
            clicks: 1,
          },
          template: 'delinquency_notice_30d',
          sent_by: 'John Smith',
          attachments: [],
        },
        {
          id: 'corr_2',
          loan_id: 'loan_3',
          type: 'letter',
          direction: 'outbound',
          subject: 'Payment Plan Agreement',
          to_address: '789 Pine Street, Capital City, IL 62701',
          date: '2023-11-20 15:00:00',
          status: 'mailed',
          delivery_status: {
            generated: '2023-11-20 15:00:00',
            mailed: '2023-11-21 09:00:00',
            delivered: null,
            expected_delivery: '2023-11-27',
          },
          template: 'payment_plan_agreement',
          sent_by: 'John Smith',
          tracking_number: 'USPS-9405511206123456789',
        },
        {
          id: 'corr_3',
          loan_id: 'loan_3',
          type: 'sms',
          direction: 'outbound',
          message: 'ServState Reminder: Your mortgage payment is past due. Please call us at 1-800-555-0199.',
          to: '(555) 555-0199',
          date: '2023-11-18 09:00:00',
          status: 'delivered',
          delivery_status: {
            sent: '2023-11-18 09:00:02',
            delivered: '2023-11-18 09:00:05',
          },
          sent_by: 'System',
          campaign: 'delinquency_reminder',
        },
        {
          id: 'corr_4',
          loan_id: 'loan_3',
          type: 'call',
          direction: 'outbound',
          date: '2023-11-15 14:30:00',
          duration: 0,
          outcome: 'voicemail',
          notes: 'Left voicemail requesting callback regarding missed payment.',
          agent: 'John Smith',
          phone_number: '(555) 555-0199',
        },
        {
          id: 'corr_5',
          loan_id: 'loan_3',
          type: 'call',
          direction: 'inbound',
          date: '2023-11-18 09:15:00',
          duration: 420,
          outcome: 'discussed',
          notes: 'Borrower returned call. Stated temporary job loss due to company restructuring. Expressed willingness to catch up once new employment secured. Discussed forbearance and payment plan options. Borrower opted for payment plan.',
          agent: 'John Smith',
          phone_number: '(555) 555-0199',
          recording_url: 'internal://recordings/call_5',
        },
        {
          id: 'corr_6',
          loan_id: 'loan_1',
          type: 'email',
          direction: 'inbound',
          subject: 'Question about escrow statement',
          from: 'j.anderson@example.com',
          to: 'servicing@servstate.com',
          date: '2023-11-25 10:30:00',
          body: 'When will I receive my annual escrow analysis statement?',
          status: 'responded',
          response_id: 'corr_7',
        },
        {
          id: 'corr_7',
          loan_id: 'loan_1',
          type: 'email',
          direction: 'outbound',
          subject: 'Re: Question about escrow statement',
          from: 'servicing@servstate.com',
          to: 'j.anderson@example.com',
          date: '2023-11-25 14:15:00',
          body: 'Dear Mr. Anderson,\n\nThank you for contacting ServState. Your annual escrow analysis will be mailed by January 15th, 2024. You can also view it in your online account Documents section once it becomes available.\n\nIf you have any other questions, please don\'t hesitate to contact us.\n\nBest regards,\nCustomer Service Team',
          status: 'opened',
          delivery_status: {
            sent: '2023-11-25 14:15:05',
            delivered: '2023-11-25 14:15:20',
            opened: '2023-11-25 16:45:00',
          },
          sent_by: 'Admin User',
          in_reply_to: 'corr_6',
          attachments: [],
        },
        {
          id: 'corr_8',
          loan_id: 'loan_2',
          type: 'email',
          direction: 'outbound',
          subject: 'Payment Confirmation',
          from: 'servicing@servstate.com',
          to: 's.jenkins@example.com',
          date: '2023-11-01 12:00:00',
          body: 'Dear Ms. Jenkins,\n\nThis confirms receipt of your payment of $2,186.45 on November 1st, 2023.\n\nPayment Breakdown:\nPrincipal & Interest: $1,636.45\nEscrow: $550.00\n\nYour next payment of $2,186.45 is due December 1st, 2023.\n\nThank you,\nServState Servicing',
          status: 'opened',
          delivery_status: {
            sent: '2023-11-01 12:00:10',
            delivered: '2023-11-01 12:00:35',
            opened: '2023-11-01 14:20:00',
          },
          template: 'payment_confirmation',
          sent_by: 'System',
          attachments: [],
        },
        {
          id: 'corr_9',
          loan_id: 'loan_5',
          type: 'email',
          direction: 'outbound',
          subject: 'Delinquency Notice - Action Required',
          from: 'servicing@servstate.com',
          to: 'david.kim@example.com',
          date: '2023-11-22 09:00:00',
          body: 'Dear Mr. Kim,\n\nYour mortgage payment due on November 1st, 2023 has not been received. Your account is now 21 days past due.\n\nAmount Due: $3,584.70\nLate Fee: $50.00\nTotal: $3,634.70\n\nPlease submit payment immediately to avoid additional late fees and potential credit bureau reporting.\n\nIf you are experiencing financial hardship, please contact us to discuss assistance options.\n\nServState Servicing\n1-800-555-0199',
          status: 'delivered',
          delivery_status: {
            sent: '2023-11-22 09:00:05',
            delivered: '2023-11-22 09:00:28',
          },
          template: 'delinquency_notice_30d',
          sent_by: 'Collections Team',
          attachments: [],
        },
        {
          id: 'corr_10',
          loan_id: 'loan_2',
          type: 'letter',
          direction: 'outbound',
          subject: 'Insurance Verification Request',
          to_address: '456 Oak Lane, Shelbyville, IL 62565',
          date: '2023-11-12 10:00:00',
          status: 'delivered',
          delivery_status: {
            generated: '2023-11-12 10:00:00',
            mailed: '2023-11-13 08:00:00',
            delivered: '2023-11-17 14:30:00',
          },
          template: 'insurance_verification',
          sent_by: 'Insurance Team',
          tracking_number: 'USPS-9405511206987654321',
        },
        {
          id: 'corr_11',
          loan_id: 'loan_1',
          type: 'call',
          direction: 'outbound',
          date: '2023-11-20 10:15:00',
          duration: 180,
          outcome: 'connected',
          notes: 'Courtesy call regarding upcoming property tax disbursement. Confirmed borrower awareness.',
          agent: 'Customer Service',
          phone_number: '(555) 123-4567',
        },
        {
          id: 'corr_12',
          loan_id: 'loan_4',
          type: 'email',
          direction: 'inbound',
          subject: 'AutoPay Enrollment',
          from: 'm.garcia@example.com',
          to: 'servicing@servstate.com',
          date: '2023-11-27 16:20:00',
          body: 'I would like to enroll in automatic payments. Please send me the enrollment form.',
          status: 'responded',
          response_id: 'corr_13',
        },
        {
          id: 'corr_13',
          loan_id: 'loan_4',
          type: 'email',
          direction: 'outbound',
          subject: 'Re: AutoPay Enrollment',
          from: 'servicing@servstate.com',
          to: 'm.garcia@example.com',
          date: '2023-11-27 17:05:00',
          body: 'Dear Ms. Garcia,\n\nThank you for your interest in AutoPay. I\'ve attached the enrollment form. Please complete and return with a voided check.\n\nYou can also enroll online through your account portal at www.servstate.com.\n\nBest regards,\nPayment Services',
          status: 'delivered',
          delivery_status: {
            sent: '2023-11-27 17:05:10',
            delivered: '2023-11-27 17:05:32',
          },
          sent_by: 'Payment Team',
          in_reply_to: 'corr_12',
          attachments: ['autopay_enrollment_form.pdf'],
        },
        {
          id: 'corr_14',
          loan_id: 'loan_5',
          type: 'call',
          direction: 'outbound',
          date: '2023-11-23 11:00:00',
          duration: 0,
          outcome: 'no_answer',
          notes: 'No answer. No voicemail available. Will attempt again tomorrow.',
          agent: 'Collections Team',
          phone_number: '(555) 987-6543',
        },
        {
          id: 'corr_15',
          loan_id: 'loan_5',
          type: 'call',
          direction: 'inbound',
          date: '2023-11-24 09:30:00',
          duration: 540,
          outcome: 'discussed',
          notes: 'Borrower called back. Discussed missed payment. Borrower requested forbearance due to medical emergency. Sent forbearance application package.',
          agent: 'Sarah Lee',
          phone_number: '(555) 987-6543',
          recording_url: 'internal://recordings/call_15',
        },
        {
          id: 'corr_16',
          loan_id: 'loan_5',
          type: 'email',
          direction: 'outbound',
          subject: 'Forbearance Application Package',
          from: 'servicing@servstate.com',
          to: 'david.kim@example.com',
          date: '2023-11-24 10:15:00',
          body: 'Dear Mr. Kim,\n\nAs discussed in our phone conversation, I\'m sending you the forbearance application package.\n\nPlease complete the attached forms and provide:\n- Hardship letter explaining your situation\n- Recent pay stubs or proof of income\n- Bank statements (last 2 months)\n\nReturn all documents within 14 days to avoid delay in processing.\n\nWe\'re here to help.\n\nSincerely,\nSarah Lee\nLoss Mitigation Specialist',
          status: 'opened',
          delivery_status: {
            sent: '2023-11-24 10:15:08',
            delivered: '2023-11-24 10:15:30',
            opened: '2023-11-24 11:05:00',
            clicks: 2,
          },
          sent_by: 'Sarah Lee',
          attachments: ['forbearance_application.pdf', 'financial_worksheet.pdf'],
        },
        {
          id: 'corr_17',
          loan_id: 'loan_1',
          type: 'letter',
          direction: 'outbound',
          subject: 'Year-End Tax Statement',
          to_address: '123 Maple Avenue, Springfield, IL 62704',
          date: '2023-11-05 14:00:00',
          status: 'delivered',
          delivery_status: {
            generated: '2023-11-05 14:00:00',
            mailed: '2023-11-06 08:00:00',
            delivered: '2023-11-10 15:00:00',
          },
          template: '1098_tax_statement',
          sent_by: 'System',
          tracking_number: 'USPS-9405511206111222333',
        },
        {
          id: 'corr_18',
          loan_id: 'loan_4',
          type: 'sms',
          direction: 'outbound',
          message: 'ServState: Your mortgage payment is due in 3 days. Pay online at servstate.com or call 1-800-555-0199.',
          to: '(555) 246-8642',
          date: '2023-11-28 09:00:00',
          status: 'delivered',
          delivery_status: {
            sent: '2023-11-28 09:00:01',
            delivered: '2023-11-28 09:00:04',
          },
          sent_by: 'System',
          campaign: 'payment_reminder',
        },
        {
          id: 'corr_19',
          loan_id: 'loan_2',
          type: 'call',
          direction: 'outbound',
          date: '2023-11-13 14:00:00',
          duration: 240,
          outcome: 'connected',
          notes: 'Called regarding insurance verification. Borrower confirmed renewal in progress with insurance company. Requested 2-week extension to provide documentation.',
          agent: 'Insurance Team',
          phone_number: '(555) 765-4321',
        },
        {
          id: 'corr_20',
          loan_id: 'loan_3',
          type: 'email',
          direction: 'outbound',
          subject: 'Payment Plan Confirmation',
          from: 'servicing@servstate.com',
          to: 'bob.vance@example.com',
          date: '2023-11-23 11:00:00',
          body: 'Dear Mr. Vance,\n\nThis confirms your enrollment in our repayment plan.\n\nPlan Details:\n- Duration: 6 months\n- Regular Payment: $3,734.15\n- Additional Amount: $750.00\n- Total Monthly Payment: $4,484.15\n- First Payment Due: December 1, 2023\n\nThank you for working with us to bring your account current.\n\nBest regards,\nJohn Smith\nLoss Mitigation',
          status: 'opened',
          delivery_status: {
            sent: '2023-11-23 11:00:05',
            delivered: '2023-11-23 11:00:28',
            opened: '2023-11-23 13:15:00',
          },
          sent_by: 'John Smith',
          attachments: ['payment_plan_schedule.pdf'],
        },
        {
          id: 'corr_21',
          loan_id: 'loan_1',
          type: 'email',
          direction: 'outbound',
          subject: 'November Payment Received',
          from: 'servicing@servstate.com',
          to: 'j.anderson@example.com',
          date: '2023-11-02 08:00:00',
          body: 'Thank you for your payment of $2,762.24 received on November 1st, 2023.\n\nNext payment due: December 1, 2023\nAmount: $2,762.24',
          status: 'opened',
          delivery_status: {
            sent: '2023-11-02 08:00:05',
            delivered: '2023-11-02 08:00:22',
            opened: '2023-11-02 09:30:00',
          },
          template: 'payment_confirmation',
          sent_by: 'System',
          attachments: [],
        },
        {
          id: 'corr_22',
          loan_id: 'loan_4',
          type: 'email',
          direction: 'outbound',
          subject: 'October Payment Received',
          from: 'servicing@servstate.com',
          to: 'm.garcia@example.com',
          date: '2023-10-03 08:00:00',
          body: 'Thank you for your payment of $2,981.20 received on October 1st, 2023.\n\nNext payment due: November 1, 2023\nAmount: $2,981.20',
          status: 'opened',
          delivery_status: {
            sent: '2023-10-03 08:00:08',
            delivered: '2023-10-03 08:00:30',
            opened: '2023-10-03 10:15:00',
          },
          template: 'payment_confirmation',
          sent_by: 'System',
          attachments: [],
        },
        {
          id: 'corr_23',
          loan_id: 'loan_3',
          type: 'sms',
          direction: 'outbound',
          message: 'ServState: Your payment plan starts Dec 1. First payment $4,484.15. Questions? Call 1-800-555-0199.',
          to: '(555) 555-0199',
          date: '2023-11-25 10:00:00',
          status: 'delivered',
          delivery_status: {
            sent: '2023-11-25 10:00:02',
            delivered: '2023-11-25 10:00:05',
          },
          sent_by: 'System',
          campaign: 'payment_plan_reminder',
        },
        {
          id: 'corr_24',
          loan_id: 'loan_2',
          type: 'call',
          direction: 'inbound',
          date: '2023-11-28 15:30:00',
          duration: 120,
          outcome: 'discussed',
          notes: 'Borrower called with general payment inquiry. Confirmed next payment due date and amount. No issues.',
          agent: 'Customer Service',
          phone_number: '(555) 765-4321',
        },
      ]

      const mockModifications = [
        {
          id: 'mod_1',
          loan_id: 'loan_3',
          type: 'payment_plan',
          status: 'active',
          created_by: 'John Smith',
          created_date: '2023-11-22',
          effective_date: '2023-12-01',
          details: {
            reason: 'Temporary hardship - job loss',
            planType: 'Repayment Plan',
            duration: 6,
            monthlyAmount: 4484.15,
            totalArrearage: 7468.30,
            catchUpAmount: 750.00,
          },
        },
        {
          id: 'mod_2',
          loan_id: 'loan_1',
          type: 'contact_update',
          status: 'completed',
          created_by: 'Admin User',
          created_date: '2023-10-15',
          effective_date: '2023-10-15',
          details: {
            field: 'email',
            oldValue: 'j.anderson@oldmail.com',
            newValue: 'j.anderson@example.com',
            verified: true,
          },
        },
        {
          id: 'mod_3',
          loan_id: 'loan_4',
          type: 'autopay_setup',
          status: 'pending',
          created_by: 'Payment Team',
          created_date: '2023-11-27',
          effective_date: '2024-01-01',
          details: {
            bankName: 'First National Bank',
            accountType: 'Checking',
            paymentDay: 1,
            amount: 2981.20,
          },
        },
        {
          id: 'mod_4',
          loan_id: 'loan_2',
          type: 'contact_update',
          status: 'completed',
          created_by: 'Customer Service',
          created_date: '2023-09-20',
          effective_date: '2023-09-20',
          details: {
            field: 'phone',
            oldValue: '(555) 765-0000',
            newValue: '(555) 765-4321',
            verified: true,
          },
        },
        {
          id: 'mod_5',
          loan_id: 'loan_3',
          type: 'fee_adjustment',
          status: 'completed',
          created_by: 'John Smith',
          created_date: '2023-11-22',
          effective_date: '2023-11-22',
          details: {
            feeType: 'Late Fee',
            originalAmount: 150.00,
            adjustedAmount: 0.00,
            reason: 'Goodwill adjustment - payment plan enrollment',
            approvedBy: 'Manager',
          },
        },
        {
          id: 'mod_6',
          loan_id: 'loan_5',
          type: 'forbearance',
          status: 'pending',
          created_by: 'Sarah Lee',
          created_date: '2023-11-24',
          effective_date: null,
          details: {
            reason: 'Medical emergency',
            requestedDuration: 3,
            applicationStatus: 'Under Review',
            documentsReceived: false,
          },
        },
        {
          id: 'mod_7',
          loan_id: 'loan_1',
          type: 'contact_update',
          status: 'completed',
          created_by: 'Admin User',
          created_date: '2023-08-10',
          effective_date: '2023-08-10',
          details: {
            field: 'mailing_address',
            oldValue: '123 Maple Avenue, Springfield, IL 62704',
            newValue: '123 Maple Avenue, Springfield, IL 62704',
            verified: true,
          },
        },
        {
          id: 'mod_8',
          loan_id: 'loan_2',
          type: 'escrow_adjustment',
          status: 'completed',
          created_by: 'Escrow Team',
          created_date: '2023-11-15',
          effective_date: '2024-01-01',
          details: {
            reason: 'Property tax increase',
            oldMonthlyAmount: 550.00,
            newMonthlyAmount: 625.00,
            shortage: 450.00,
            spreadOverMonths: 12,
          },
        },
        {
          id: 'mod_9',
          loan_id: 'loan_4',
          type: 'contact_update',
          status: 'completed',
          created_by: 'Customer Service',
          created_date: '2023-11-01',
          effective_date: '2023-11-01',
          details: {
            field: 'email',
            oldValue: 'maria.garcia@oldmail.com',
            newValue: 'm.garcia@example.com',
            verified: true,
          },
        },
        {
          id: 'mod_10',
          loan_id: 'loan_3',
          type: 'late_fee_waiver',
          status: 'completed',
          created_by: 'Collections Team',
          created_date: '2023-11-08',
          effective_date: '2023-11-08',
          details: {
            amount: 75.00,
            reason: 'First-time courtesy waiver',
            approvedBy: 'Supervisor',
          },
        },
      ]

      // ============ MOCK REPORT DATA ============
      const mockReports = {
        delinquency: {
          generatedDate: '2023-12-01',
          summary: {
            total30Days: 8,
            total60Days: 3,
            total90Days: 2,
            totalDelinquent: 13,
            totalUPB: 3450000,
          },
          byLoanType: [
            { type: 'Conventional', count30: 5, count60: 2, count90: 1, upb: 2100000 },
            { type: 'FHA', count30: 2, count60: 1, count90: 1, upb: 950000 },
            { type: 'VA', count30: 1, count60: 0, count90: 0, upb: 400000 },
          ],
          trend: [
            { month: 'Aug 2023', count30: 6, count60: 2, count90: 1 },
            { month: 'Sep 2023', count30: 7, count60: 3, count90: 1 },
            { month: 'Oct 2023', count30: 7, count60: 2, count90: 2 },
            { month: 'Nov 2023', count30: 8, count60: 3, count90: 2 },
          ],
        },
        portfolio: {
          generatedDate: '2023-12-01',
          summary: {
            totalLoans: 247,
            totalUPB: 85400000,
            avgLoanSize: 345748,
            avgInterestRate: 4.32,
          },
          byStatus: [
            { status: 'Current', count: 232, upb: 80250000, percentage: 93.9 },
            { status: 'Delinquent', count: 13, upb: 4650000, percentage: 5.3 },
            { status: 'Forbearance', count: 2, upb: 500000, percentage: 0.8 },
          ],
          byType: [
            { type: 'Conventional', count: 145, upb: 52300000, percentage: 61.2 },
            { type: 'FHA', count: 68, upb: 22100000, percentage: 25.9 },
            { type: 'VA', count: 34, upb: 11000000, percentage: 12.9 },
          ],
          byOriginationYear: [
            { year: '2023', count: 42, upb: 15200000 },
            { year: '2022', count: 68, upb: 24800000 },
            { year: '2021', count: 85, upb: 30500000 },
            { year: '2020', count: 52, upb: 14900000 },
          ],
        },
        paymentActivity: {
          generatedDate: '2023-12-01',
          summary: {
            mtdCollections: 2845000,
            ytdCollections: 32150000,
            mtdPaymentCount: 238,
            ytdPaymentCount: 2784,
            mtdLateFees: 8500,
            ytdLateFees: 98400,
          },
          monthlyTrend: [
            { month: 'Jan', collections: 2750000, paymentCount: 235, lateFees: 7200 },
            { month: 'Feb', collections: 2720000, paymentCount: 232, lateFees: 8100 },
            { month: 'Mar', collections: 2810000, paymentCount: 240, lateFees: 7800 },
            { month: 'Apr', collections: 2790000, paymentCount: 237, lateFees: 8300 },
            { month: 'May', collections: 2825000, paymentCount: 239, lateFees: 7900 },
            { month: 'Jun', collections: 2800000, paymentCount: 236, lateFees: 8200 },
            { month: 'Jul', collections: 2835000, paymentCount: 240, lateFees: 7600 },
            { month: 'Aug', collections: 2815000, paymentCount: 238, lateFees: 8400 },
            { month: 'Sep', collections: 2828000, paymentCount: 239, lateFees: 7700 },
            { month: 'Oct', collections: 2842000, paymentCount: 240, lateFees: 8100 },
            { month: 'Nov', collections: 2845000, paymentCount: 238, lateFees: 8500 },
          ],
          collectionRate: {
            current: 98.5,
            target: 98.0,
            previous: 97.8,
          },
        },
        escrow: {
          generatedDate: '2023-12-01',
          summary: {
            totalEscrowBalance: 3250000,
            loansWithEscrow: 198,
            shortageAccounts: 12,
            surplusAccounts: 8,
            avgCushion: 1850,
          },
          shortages: [
            { loanNumber: '10001122', borrower: 'Robert Vance', shortage: 1200, action: 'Repayment Plan' },
            { loanNumber: '10001145', borrower: 'David Lee', shortage: 850, action: 'Payment Increase' },
            { loanNumber: '10001156', borrower: 'Emily Chen', shortage: 1450, action: 'Lump Sum Payment' },
            { loanNumber: '10001178', borrower: 'James Wilson', shortage: 920, action: 'Payment Increase' },
            { loanNumber: '10001189', borrower: 'Lisa Anderson', shortage: 1100, action: 'Repayment Plan' },
            { loanNumber: '10001201', borrower: 'Mark Taylor', shortage: 780, action: 'Payment Increase' },
            { loanNumber: '10001215', borrower: 'Nancy White', shortage: 1350, action: 'Lump Sum Payment' },
            { loanNumber: '10001229', borrower: 'Paul Harris', shortage: 890, action: 'Repayment Plan' },
            { loanNumber: '10001234', borrower: 'Rachel Clark', shortage: 1050, action: 'Payment Increase' },
            { loanNumber: '10001245', borrower: 'Steven Lewis', shortage: 950, action: 'Repayment Plan' },
            { loanNumber: '10001256', borrower: 'Tina Robinson', shortage: 820, action: 'Payment Increase' },
            { loanNumber: '10001267', borrower: 'Victor Martinez', shortage: 1180, action: 'Lump Sum Payment' },
          ],
          surpluses: [
            { loanNumber: '10001089', borrower: 'Sarah Johnson', surplus: 2400, action: 'Refund Issued' },
            { loanNumber: '10001098', borrower: 'Thomas Brown', surplus: 1950, action: 'Apply to Principal' },
            { loanNumber: '10001112', borrower: 'Karen Davis', surplus: 1650, action: 'Refund Issued' },
            { loanNumber: '10001134', borrower: 'George Miller', surplus: 2100, action: 'Apply to Principal' },
            { loanNumber: '10001167', borrower: 'Jennifer Moore', surplus: 1800, action: 'Refund Issued' },
            { loanNumber: '10001192', borrower: 'Kevin Jackson', surplus: 2250, action: 'Apply to Principal' },
            { loanNumber: '10001209', borrower: 'Laura Thompson', surplus: 1720, action: 'Refund Issued' },
            { loanNumber: '10001223', borrower: 'Michael Garcia', surplus: 1980, action: 'Apply to Principal' },
          ],
        },
      }

      const amortizationData = Array.from({ length: 360 }, (_, i) => {
        const month = i + 1
        const principal = 350000 * Math.pow(1 - 0.003, month)
        return {
          month,
          principal: Math.max(0, principal),
          interest: 350000 * 0.003 * Math.pow(0.997, month),
        }
      })

      const portfolioChartData = [
        { month: 'Jul', collections: 125000, disbursements: 45000 },
        { month: 'Aug', collections: 132000, disbursements: 48000 },
        { month: 'Sep', collections: 128000, disbursements: 52000 },
        { month: 'Oct', collections: 145000, disbursements: 47000 },
        { month: 'Nov', collections: 142000, disbursements: 51000 },
        { month: 'Dec', collections: 138000, disbursements: 49000 },
      ]

      // ============ ICON HELPER ============
      const Icon = ({ name, size = 18, className = '' }) => {
        useEffect(() => {
          if (window.lucide) window.lucide.createIcons()
        })
        return (
          <i
            data-lucide={name}
            className={className}
            style={{ width: size, height: size }}
          />
        )
      }

      // ============ UI COMPONENTS ============
      const Button = ({
        children,
        variant = 'default',
        size = 'default',
        className = '',
        ...props
      }) => {
        const base =
          'inline-flex items-center justify-center gap-2 rounded-lg text-sm font-semibold transition-all duration-200 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 active:scale-[0.98]'
        const variants = {
          default:
            'bg-primary text-primary-foreground hover:bg-primary/90 shadow-md hover:shadow-lg btn-glow',
          destructive:
            'bg-destructive text-destructive-foreground hover:bg-destructive/90 shadow-md',
          outline:
            'border-2 border-input bg-background hover:bg-accent/10 hover:border-primary/50',
          secondary:
            'bg-secondary text-secondary-foreground hover:bg-secondary/80',
          ghost: 'hover:bg-accent/10 hover:text-accent-foreground',
          link: 'text-primary underline-offset-4 hover:underline',
        }
        const sizes = {
          default: 'h-11 px-5 py-2',
          sm: 'h-9 px-4 text-xs',
          lg: 'h-12 px-8',
          icon: 'h-10 w-10',
        }
        return (
          <button
            className={`${base} ${variants[variant]} ${sizes[size]} ${className}`}
            {...props}
          >
            {children}
          </button>
        )
      }

      const Card = ({ children, className = '', hover = false }) => (
        <div
          className={`rounded-xl border bg-card text-card-foreground shadow-sm ${
            hover
              ? 'hover:shadow-lg hover:-translate-y-0.5 transition-all duration-300'
              : ''
          } ${className}`}
        >
          {children}
        </div>
      )

      const Input = ({ className = '', ...props }) => (
        <input
          className={`flex h-11 w-full rounded-lg border border-input bg-background px-4 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:border-primary transition-all ${className}`}
          {...props}
        />
      )

      const Badge = ({ children, variant = 'default', className = '' }) => {
        const variants = {
          default: 'bg-primary/15 text-primary border-primary/20',
          secondary: 'bg-secondary text-secondary-foreground',
          destructive:
            'bg-destructive/15 text-destructive border-destructive/20',
          success: 'bg-emerald-500/15 text-emerald-700 border-emerald-500/20',
          warning: 'bg-amber-500/15 text-amber-700 border-amber-500/20',
          outline: 'border-2',
        }
        return (
          <span
            className={`inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors ${variants[variant]} ${className}`}
          >
            {children}
          </span>
        )
      }

      const Separator = ({ className = '', orientation = 'horizontal' }) => (
        <div
          className={`shrink-0 bg-border ${
            orientation === 'horizontal' ? 'h-[1px] w-full' : 'w-[1px] h-full'
          } ${className}`}
        />
      )

      const Avatar = ({ name, size = 40, className = '' }) => {
        const initials = name
          .split(' ')
          .map((n) => n[0])
          .join('')
          .slice(0, 2)
        return (
          <div
            className={`rounded-full bg-gradient-to-br from-primary to-primary/70 flex items-center justify-center text-primary-foreground font-bold ${className}`}
            style={{ width: size, height: size, fontSize: size * 0.4 }}
          >
            {initials}
          </div>
        )
      }

      const Progress = ({ value, className = '', showLabel = false }) => (
        <div className={`relative ${className}`}>
          <div className="h-2 w-full bg-secondary rounded-full overflow-hidden">
            <div
              className="h-full bg-gradient-to-r from-primary to-primary/80 rounded-full transition-all duration-500"
              style={{ width: `${Math.min(100, Math.max(0, value))}%` }}
            />
          </div>
          {showLabel && (
            <span
              className="absolute -top-6 text-xs font-medium text-muted-foreground"
              style={{ left: `${value}%`, transform: 'translateX(-50%)' }}
            >
              {value.toFixed(1)}%
            </span>
          )}
        </div>
      )

      const Skeleton = ({ className = '' }) => (
        <div className={`skeleton rounded-lg ${className}`} />
      )

      const Tabs = ({ tabs, activeTab, onChange, className = '' }) => (
        <div className={`flex gap-1 p-1 bg-muted rounded-lg ${className}`}>
          {tabs.map((tab) => (
            <button
              key={tab.id}
              onClick={() => onChange(tab.id)}
              className={`flex-1 px-4 py-2 text-sm font-medium rounded-md transition-all ${
                activeTab === tab.id
                  ? 'bg-background text-foreground shadow-sm'
                  : 'text-muted-foreground hover:text-foreground'
              }`}
            >
              {tab.label}
            </button>
          ))}
        </div>
      )

      const Toast = ({ message, type = 'success', onClose }) => (
        <div
          className={`fixed bottom-4 right-4 z-50 animate-slide-in-right flex items-center gap-3 px-4 py-3 rounded-lg shadow-lg ${
            type === 'success'
              ? 'bg-emerald-600 text-white'
              : type === 'error'
              ? 'bg-destructive text-white'
              : 'bg-card border'
          }`}
        >
          <Icon
            name={
              type === 'success'
                ? 'check-circle'
                : type === 'error'
                ? 'x-circle'
                : 'info'
            }
            size={20}
          />
          <span className="font-medium">{message}</span>
          <button
            onClick={onClose}
            className="ml-2 opacity-70 hover:opacity-100"
          >
            <Icon name="x" size={16} />
          </button>
        </div>
      )

      // ============ NAVIGATION SIDEBAR ============
      const Sidebar = ({
        collapsed,
        setCollapsed,
        items,
        activeItem,
        onItemClick,
        userType,
      }) => (
        <aside
          className={`fixed left-0 top-0 h-screen bg-card border-r z-40 transition-all duration-300 flex flex-col ${
            collapsed ? 'w-[72px]' : 'w-64'
          }`}
        >
          <div
            className={`h-16 flex items-center border-b px-4 ${
              collapsed ? 'justify-center' : 'gap-3'
            }`}
          >
            <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-primary to-primary/70 flex items-center justify-center shadow-lg">
              <Icon name="building-2" size={22} className="text-white" />
            </div>
            {!collapsed && (
              <span className="font-bold text-lg tracking-tight">
                ServState
              </span>
            )}
          </div>
          <nav className="flex-1 py-4 px-3 space-y-1 overflow-y-auto">
            {items.map((item) => (
              <button
                key={item.id}
                onClick={() => onItemClick(item.id)}
                className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-all ${
                  activeItem === item.id
                    ? 'bg-primary/10 text-primary'
                    : 'text-muted-foreground hover:bg-muted hover:text-foreground'
                } ${collapsed ? 'justify-center' : ''}`}
                title={collapsed ? item.label : undefined}
              >
                <Icon name={item.icon} size={20} />
                {!collapsed && <span>{item.label}</span>}
                {!collapsed && item.badge && (
                  <Badge
                    variant={item.badgeVariant || 'default'}
                    className="ml-auto"
                  >
                    {item.badge}
                  </Badge>
                )}
              </button>
            ))}
          </nav>
          <div className="p-3 border-t">
            <button
              onClick={() => setCollapsed(!collapsed)}
              className="w-full flex items-center justify-center gap-2 px-3 py-2 rounded-lg text-muted-foreground hover:bg-muted hover:text-foreground transition-all"
            >
              <Icon
                name={collapsed ? 'chevrons-right' : 'chevrons-left'}
                size={20}
              />
              {!collapsed && <span className="text-sm">Collapse</span>}
            </button>
          </div>
        </aside>
      )

      // ============ HEADER ============
      const Header = ({ title, subtitle, breadcrumbs = [], actions, user }) => {
        const [profileDropdownOpen, setProfileDropdownOpen] = useState(false)
        const dropdownRef = React.useRef(null)

        // Close dropdown when clicking outside
        useEffect(() => {
          const handleClickOutside = (event) => {
            if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
              setProfileDropdownOpen(false)
            }
          }
          document.addEventListener('mousedown', handleClickOutside)
          return () => document.removeEventListener('mousedown', handleClickOutside)
        }, [])

        return (
          <header className="sticky top-0 z-30 glass border-b">
            <div className="h-16 px-6 flex items-center justify-between">
              <div className="flex items-center gap-4">
                {breadcrumbs.length > 0 && (
                  <nav className="flex items-center gap-2 text-sm">
                    {breadcrumbs.map((crumb, i) => (
                      <React.Fragment key={i}>
                        {i > 0 && (
                          <Icon
                            name="chevron-right"
                            size={14}
                            className="text-muted-foreground"
                          />
                        )}
                        <span
                          className={
                            i === breadcrumbs.length - 1
                              ? 'font-medium'
                              : 'text-muted-foreground hover:text-foreground cursor-pointer'
                          }
                        >
                          {crumb}
                        </span>
                      </React.Fragment>
                    ))}
                  </nav>
                )}
                {!breadcrumbs.length && (
                  <div>
                    <h1 className="text-xl font-bold tracking-tight">{title}</h1>
                    {subtitle && (
                      <p className="text-sm text-muted-foreground">{subtitle}</p>
                    )}
                  </div>
                )}
              </div>
              <div className="flex items-center gap-3">
                {actions}
                <button className="relative p-2 rounded-md hover:bg-muted transition-colors">
                  <Icon name="bell" size={20} className="text-muted-foreground" />
                  <span className="absolute top-1.5 right-1.5 w-2 h-2 bg-destructive rounded-full ring-2 ring-background" />
                </button>
                <Separator orientation="vertical" className="h-8 mx-2" />
                {/* Profile Dropdown */}
                <div className="relative" ref={dropdownRef}>
                  <button
                    onClick={() => setProfileDropdownOpen(!profileDropdownOpen)}
                    className="flex items-center gap-3 p-1.5 -m-1.5 rounded-md hover:bg-muted transition-colors cursor-pointer"
                  >
                    <Avatar name={user?.name || 'User'} size={36} />
                    <div className="hidden md:block text-left">
                      <p className="text-sm font-medium">{user?.name || 'User'}</p>
                      <p className="text-xs text-muted-foreground">
                        {user?.role || 'Borrower'}
                      </p>
                    </div>
                    <Icon
                      name="chevron-down"
                      size={16}
                      className={`hidden md:block text-muted-foreground transition-transform duration-200 ${
                        profileDropdownOpen ? 'rotate-180' : ''
                      }`}
                    />
                  </button>
                  {/* Dropdown Menu */}
                  {profileDropdownOpen && (
                    <div className="absolute right-0 top-full mt-2 w-56 rounded-lg border bg-popover p-1 shadow-lg animate-in fade-in-0 zoom-in-95 slide-in-from-top-2">
                      <div className="px-3 py-2 border-b mb-1">
                        <p className="text-sm font-medium">{user?.name || 'User'}</p>
                        <p className="text-xs text-muted-foreground">{user?.role || 'Borrower'}</p>
                      </div>
                      <button
                        className="w-full flex items-center gap-2 px-2 py-1.5 text-sm rounded-sm hover:bg-muted transition-colors text-left"
                        onClick={() => setProfileDropdownOpen(false)}
                      >
                        <Icon name="user" size={16} className="text-muted-foreground" />
                        Profile
                      </button>
                      <button
                        className="w-full flex items-center gap-2 px-2 py-1.5 text-sm rounded-sm hover:bg-muted transition-colors text-left"
                        onClick={() => setProfileDropdownOpen(false)}
                      >
                        <Icon name="settings" size={16} className="text-muted-foreground" />
                        Settings
                      </button>
                      <Separator className="my-1" />
                      <button
                        className="w-full flex items-center gap-2 px-2 py-1.5 text-sm rounded-sm hover:bg-muted transition-colors text-left text-destructive"
                        onClick={() => {
                          // TODO: Implement logout functionality when auth is added
                          // This will call the auth signOut method and redirect to login
                          setProfileDropdownOpen(false)
                        }}
                      >
                        <Icon name="log-out" size={16} />
                        Log out
                      </button>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </header>
        )
      }

      // ============ STAT CARD ============
      const StatCard = ({
        title,
        value,
        subtitle,
        icon,
        trend,
        trendUp,
        className = '',
      }) => (
        <Card hover className={`p-6 ${className}`}>
          <div className="flex items-start justify-between">
            <div className="space-y-1">
              <p className="text-xs font-semibold uppercase tracking-wider text-muted-foreground">
                {title}
              </p>
              <h3 className="text-3xl font-bold tracking-tight">{value}</h3>
              {subtitle && (
                <p className="text-sm text-muted-foreground">{subtitle}</p>
              )}
              {trend && (
                <div
                  className={`flex items-center gap-1 text-sm font-medium ${
                    trendUp ? 'text-emerald-600' : 'text-destructive'
                  }`}
                >
                  <Icon
                    name={trendUp ? 'trending-up' : 'trending-down'}
                    size={16}
                  />
                  <span>{trend}</span>
                </div>
              )}
            </div>
            <div className={`p-3 rounded-xl ${icon?.bg || 'bg-primary/10'}`}>
              <Icon
                name={icon?.name || 'activity'}
                size={24}
                className={icon?.color || 'text-primary'}
              />
            </div>
          </div>
        </Card>
      )

      // ============ LOAN PROGRESS RING ============
      const ProgressRing = ({
        value,
        size = 160,
        strokeWidth = 12,
        label,
        sublabel,
      }) => {
        const radius = (size - strokeWidth) / 2
        const circumference = radius * 2 * Math.PI
        const offset = circumference - (value / 100) * circumference
        return (
          <div className="relative" style={{ width: size, height: size }}>
            <svg width={size} height={size} className="-rotate-90">
              <circle
                cx={size / 2}
                cy={size / 2}
                r={radius}
                fill="none"
                stroke="hsl(var(--muted))"
                strokeWidth={strokeWidth}
              />
              <circle
                cx={size / 2}
                cy={size / 2}
                r={radius}
                fill="none"
                stroke="url(#gradient)"
                strokeWidth={strokeWidth}
                strokeDasharray={circumference}
                strokeDashoffset={offset}
                strokeLinecap="round"
                className="transition-all duration-1000"
              />
              <defs>
                <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" stopColor="hsl(var(--primary))" />
                  <stop offset="100%" stopColor="hsl(var(--accent))" />
                </linearGradient>
              </defs>
            </svg>
            <div className="absolute inset-0 flex flex-col items-center justify-center">
              <span className="text-3xl font-bold">{value.toFixed(1)}%</span>
              <span className="text-xs text-muted-foreground uppercase tracking-wider">
                {label}
              </span>
            </div>
          </div>
        )
      }

      // ============ DATA TABLE ============
      const DataTable = ({ columns, data, onRowClick, sortable = true }) => {
        const [sortConfig, setSortConfig] = useState({
          key: null,
          direction: 'asc',
        })
        const sortedData = useMemo(() => {
          if (!sortConfig.key) return data
          return [...data].sort((a, b) => {
            const aVal = a[sortConfig.key]
            const bVal = b[sortConfig.key]
            if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1
            if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1
            return 0
          })
        }, [data, sortConfig])
        const handleSort = (key) => {
          if (!sortable) return
          setSortConfig((prev) => ({
            key,
            direction:
              prev.key === key && prev.direction === 'asc' ? 'desc' : 'asc',
          }))
        }
        return (
          <div className="overflow-x-auto rounded-lg border">
            <table className="w-full text-sm">
              <thead className="bg-muted/50">
                <tr>
                  {columns.map((col) => (
                    <th
                      key={col.key}
                      onClick={() =>
                        col.sortable !== false && handleSort(col.key)
                      }
                      className={`px-4 py-3 text-left font-semibold text-muted-foreground ${
                        col.sortable !== false && sortable
                          ? 'cursor-pointer hover:text-foreground'
                          : ''
                      } ${col.className || ''}`}
                    >
                      <div className="flex items-center gap-2">
                        {col.label}
                        {sortConfig.key === col.key && (
                          <Icon
                            name={
                              sortConfig.direction === 'asc'
                                ? 'chevron-up'
                                : 'chevron-down'
                            }
                            size={14}
                          />
                        )}
                      </div>
                    </th>
                  ))}
                </tr>
              </thead>
              <tbody className="divide-y">
                {sortedData.map((row, i) => (
                  <tr
                    key={row.id || i}
                    onClick={() => onRowClick?.(row)}
                    className={`hover:bg-muted/30 transition-colors ${
                      onRowClick ? 'cursor-pointer' : ''
                    }`}
                  >
                    {columns.map((col) => (
                      <td
                        key={col.key}
                        className={`px-4 py-4 ${col.className || ''}`}
                      >
                        {col.render
                          ? col.render(row[col.key], row)
                          : row[col.key]}
                      </td>
                    ))}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )
      }

      // ============ SHEET (Slide-over Panel) ============
      const Sheet = ({
        open,
        onClose,
        title,
        children,
        width = 'max-w-lg',
      }) => {
        if (!open) return null
        return (
          <div className="fixed inset-0 z-50">
            <div
              className="absolute inset-0 bg-black/50 backdrop-blur-sm animate-fade-in"
              onClick={onClose}
            />
            <div
              className={`absolute right-0 top-0 h-full w-full ${width} bg-card shadow-2xl animate-slide-in-right overflow-y-auto`}
            >
              <div className="sticky top-0 bg-card border-b px-6 py-4 flex items-center justify-between z-10">
                <h2 className="text-lg font-bold">{title}</h2>
                <button
                  onClick={onClose}
                  className="p-2 rounded-lg hover:bg-muted transition-colors"
                >
                  <Icon name="x" size={20} />
                </button>
              </div>
              <div className="p-6">{children}</div>
            </div>
          </div>
        )
      }

      // ============ MODAL ============
      const Modal = ({ open, onClose, title, children, size = 'max-w-md' }) => {
        if (!open) return null
        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
            <div
              className="absolute inset-0 bg-black/50 backdrop-blur-sm animate-fade-in"
              onClick={onClose}
            />
            <div
              className={`relative w-full ${size} bg-card rounded-2xl shadow-2xl animate-scale-in overflow-hidden`}
            >
              <div className="border-b px-6 py-4 flex items-center justify-between">
                <h2 className="text-lg font-bold">{title}</h2>
                <button
                  onClick={onClose}
                  className="p-2 rounded-lg hover:bg-muted transition-colors"
                >
                  <Icon name="x" size={20} />
                </button>
              </div>
              <div className="p-6">{children}</div>
            </div>
          </div>
        )
      }

      // ============ EMPTY STATE ============
      const EmptyState = ({ icon, title, description, action }) => (
        <div className="flex flex-col items-center justify-center py-12 text-center">
          <div className="w-16 h-16 rounded-full bg-muted flex items-center justify-center mb-4">
            <Icon name={icon} size={32} className="text-muted-foreground" />
          </div>
          <h3 className="font-semibold text-lg mb-1">{title}</h3>
          <p className="text-muted-foreground text-sm max-w-sm mb-4">
            {description}
          </p>
          {action}
        </div>
      )

      // ============ QUICK ACTION CARD ============
      const QuickAction = ({
        icon,
        label,
        description,
        onClick,
        variant = 'default',
      }) => (
        <button
          onClick={onClick}
          className={`p-4 rounded-xl border-2 border-dashed text-left transition-all hover:border-primary/50 hover:bg-primary/5 group ${
            variant === 'primary'
              ? 'border-primary/30 bg-primary/5'
              : 'border-muted'
          }`}
        >
          <div
            className={`w-10 h-10 rounded-lg flex items-center justify-center mb-3 transition-colors ${
              variant === 'primary'
                ? 'bg-primary text-primary-foreground'
                : 'bg-muted group-hover:bg-primary/10'
            }`}
          >
            <Icon
              name={icon}
              size={20}
              className={
                variant === 'primary'
                  ? ''
                  : 'text-muted-foreground group-hover:text-primary'
              }
            />
          </div>
          <p className="font-semibold text-sm">{label}</p>
          <p className="text-xs text-muted-foreground mt-1">{description}</p>
        </button>
      )

      // ============ CHARTS (CSS-based) ============
      const CHART_COLORS = [
        'hsl(168, 76%, 36%)',
        'hsl(36, 100%, 50%)',
        'hsl(220, 70%, 50%)',
        'hsl(280, 70%, 50%)',
      ]

      const PaymentBreakdownChart = ({ data }) => {
        const total = data.reduce((sum, d) => sum + d.value, 0)
        let cumulativePercent = 0
        const segments = data.map((d, i) => {
          const percent = (d.value / total) * 100
          const start = cumulativePercent
          cumulativePercent += percent
          return { ...d, percent, start, color: CHART_COLORS[i] }
        })
        const gradientString = segments
          .map((s) => `${s.color} ${s.start}% ${s.start + s.percent}%`)
          .join(', ')
        return (
          <div className="flex flex-col items-center">
            <div className="relative w-40 h-40">
              <div
                className="w-full h-full rounded-full"
                style={{ background: `conic-gradient(${gradientString})` }}
              />
              <div className="absolute inset-4 bg-card rounded-full flex flex-col items-center justify-center">
                <span className="text-xl font-bold">${total.toFixed(0)}</span>
                <span className="text-xs text-muted-foreground">Monthly</span>
              </div>
            </div>
          </div>
        )
      }

      const AmortizationChart = ({ data }) => {
        const maxVal = Math.max(
          ...data.filter((_, i) => i % 24 === 0).map((d) => d.principal)
        )
        const points = data
          .filter((_, i) => i % 24 === 0)
          .map((d, i, arr) => {
            const x = (i / (arr.length - 1)) * 100
            const y = 100 - (d.principal / maxVal) * 100
            return `${x},${y}`
          })
          .join(' ')
        return (
          <div className="w-full h-48 relative">
            <svg
              viewBox="0 0 100 100"
              preserveAspectRatio="none"
              className="w-full h-full"
            >
              <defs>
                <linearGradient id="areaGrad" x1="0" y1="0" x2="0" y2="1">
                  <stop
                    offset="0%"
                    stopColor="hsl(168, 76%, 36%)"
                    stopOpacity="0.3"
                  />
                  <stop
                    offset="100%"
                    stopColor="hsl(168, 76%, 36%)"
                    stopOpacity="0.05"
                  />
                </linearGradient>
              </defs>
              <polygon
                points={`0,100 ${points} 100,100`}
                fill="url(#areaGrad)"
              />
              <polyline
                points={points}
                fill="none"
                stroke="hsl(168, 76%, 36%)"
                strokeWidth="0.5"
              />
            </svg>
            <div className="absolute bottom-0 left-0 right-0 flex justify-between text-xs text-muted-foreground px-2">
              <span>Year 0</span>
              <span>Year 15</span>
              <span>Year 30</span>
            </div>
          </div>
        )
      }

      const PortfolioChart = ({ data }) => {
        const maxVal = Math.max(
          ...data.map((d) => Math.max(d.collections, d.disbursements))
        )
        return (
          <div className="space-y-4">
            {data.map((d, i) => (
              <div key={i} className="space-y-2">
                <div className="flex justify-between text-sm">
                  <span className="font-medium">{d.month}</span>
                  <span className="text-muted-foreground">
                    ${(d.collections / 1000).toFixed(0)}k / $
                    {(d.disbursements / 1000).toFixed(0)}k
                  </span>
                </div>
                <div className="flex gap-1 h-6">
                  <div
                    className="bg-primary rounded transition-all"
                    style={{ width: `${(d.collections / maxVal) * 70}%` }}
                    title={`Collections: $${d.collections.toLocaleString()}`}
                  />
                  <div
                    className="bg-amber-500 rounded transition-all"
                    style={{ width: `${(d.disbursements / maxVal) * 70}%` }}
                    title={`Disbursements: $${d.disbursements.toLocaleString()}`}
                  />
                </div>
              </div>
            ))}
            <div className="flex gap-4 text-xs text-muted-foreground pt-2">
              <span className="flex items-center gap-1">
                <span className="w-3 h-3 rounded bg-primary" />
                Collections
              </span>
              <span className="flex items-center gap-1">
                <span className="w-3 h-3 rounded bg-amber-500" />
                Disbursements
              </span>
            </div>
          </div>
        )
      }

      // ============ BORROWER VIEWS ============
      const BorrowerDashboard = ({ loan, transactions }) => {
        const paidPercent =
          ((loan.original_principal - loan.current_principal) /
            loan.original_principal) *
          100
        const myTx = transactions
          .filter((t) => t.loan_id === loan.id)
          .slice(0, 5)
        const totalDue = loan.monthly_pi + loan.monthly_escrow
        const paymentData = [
          { name: 'Principal', value: loan.monthly_pi * 0.18 },
          { name: 'Interest', value: loan.monthly_pi * 0.82 },
          { name: 'Escrow', value: loan.monthly_escrow },
        ]
        const daysUntilDue = Math.max(
          0,
          Math.ceil(
            (new Date(loan.next_due_date) - new Date()) / (1000 * 60 * 60 * 24)
          )
        )

        return (
          <div className="space-y-8">
            {/* Hero Stats */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              <StatCard
                title="Principal Balance"
                value={`$${loan.current_principal.toLocaleString()}`}
                subtitle={`of $${loan.original_principal.toLocaleString()} original`}
                icon={{
                  name: 'wallet',
                  bg: 'bg-primary/10',
                  color: 'text-primary',
                }}
                className="animate-in stagger-1"
              />
              <StatCard
                title="Next Payment"
                value={`$${totalDue.toLocaleString()}`}
                subtitle={`Due in ${daysUntilDue} days`}
                icon={{
                  name: 'calendar',
                  bg: 'bg-amber-500/10',
                  color: 'text-amber-600',
                }}
                className="animate-in stagger-2 gradient-border"
              />
              <StatCard
                title="Interest Rate"
                value={`${(loan.interest_rate * 100).toFixed(3)}%`}
                subtitle={`${loan.loan_type}  ${
                  loan.term_months / 12
                }-year fixed`}
                icon={{
                  name: 'percent',
                  bg: 'bg-blue-500/10',
                  color: 'text-blue-600',
                }}
                className="animate-in stagger-3"
              />
              <StatCard
                title="Escrow Balance"
                value={`$${loan.escrow_balance.toLocaleString()}`}
                subtitle="Taxes & Insurance Reserve"
                icon={{
                  name: 'piggy-bank',
                  bg: 'bg-emerald-500/10',
                  color: 'text-emerald-600',
                }}
                className="animate-in stagger-4"
              />
            </div>

            {/* Main Content Grid */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              {/* Progress & Chart */}
              <Card className="p-6 lg:col-span-2 animate-in">
                <div className="flex items-center justify-between mb-6">
                  <div>
                    <h3 className="font-bold text-lg">Loan Progress</h3>
                    <p className="text-sm text-muted-foreground">
                      Your mortgage payoff journey
                    </p>
                  </div>
                  <Badge variant="success">
                    {loan.payments_made} payments made
                  </Badge>
                </div>
                <div className="flex flex-col md:flex-row items-center gap-8">
                  <ProgressRing value={paidPercent} label="Paid Off" />
                  <div className="flex-1 w-full">
                    <p className="text-sm font-medium mb-3">
                      Principal Balance Over Time
                    </p>
                    <AmortizationChart data={amortizationData} />
                  </div>
                </div>
              </Card>

              {/* Payment Breakdown */}
              <Card className="p-6 animate-in">
                <h3 className="font-bold text-lg mb-2">Payment Breakdown</h3>
                <p className="text-sm text-muted-foreground mb-4">
                  Where your monthly payment goes
                </p>
                <PaymentBreakdownChart data={paymentData} />
                <div className="space-y-3 mt-4">
                  {paymentData.map((item, i) => (
                    <div
                      key={item.name}
                      className="flex items-center justify-between text-sm"
                    >
                      <div className="flex items-center gap-2">
                        <div
                          className="w-3 h-3 rounded-full"
                          style={{ backgroundColor: CHART_COLORS[i] }}
                        />
                        <span>{item.name}</span>
                      </div>
                      <span className="font-semibold">
                        ${item.value.toFixed(0)}
                      </span>
                    </div>
                  ))}
                </div>
              </Card>
            </div>

            {/* Quick Actions & Recent Activity */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              {/* Quick Actions */}
              <Card className="p-6 animate-in">
                <h3 className="font-bold text-lg mb-4">Quick Actions</h3>
                <div className="grid grid-cols-2 gap-3">
                  <QuickAction
                    icon="credit-card"
                    label="Make Payment"
                    description="Pay now"
                    variant="primary"
                  />
                  <QuickAction
                    icon="file-text"
                    label="View Statement"
                    description="Latest statement"
                  />
                  <QuickAction
                    icon="calculator"
                    label="Payoff Quote"
                    description="Request quote"
                  />
                  <QuickAction
                    icon="message-circle"
                    label="Contact Us"
                    description="Get support"
                  />
                </div>
              </Card>

              {/* Recent Activity */}
              <Card className="p-6 lg:col-span-2 animate-in">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="font-bold text-lg">Recent Activity</h3>
                  <Button variant="ghost" size="sm">
                    View All
                  </Button>
                </div>
                <div className="space-y-4">
                  {myTx.map((tx) => (
                    <div
                      key={tx.id}
                      className="flex items-center justify-between p-3 rounded-lg hover:bg-muted/50 transition-colors"
                    >
                      <div className="flex items-center gap-3">
                        <div
                          className={`p-2 rounded-lg ${
                            tx.type === 'Payment'
                              ? 'bg-emerald-500/10 text-emerald-600'
                              : 'bg-muted text-muted-foreground'
                          }`}
                        >
                          <Icon
                            name={
                              tx.type === 'Payment' ? 'check-circle' : 'info'
                            }
                            size={18}
                          />
                        </div>
                        <div>
                          <p className="font-medium text-sm">{tx.type}</p>
                          <p className="text-xs text-muted-foreground">
                            {tx.date}
                          </p>
                        </div>
                      </div>
                      <div className="text-right">
                        <p
                          className={`font-bold ${
                            tx.type === 'Payment' ? 'text-emerald-600' : ''
                          }`}
                        >
                          -${tx.amount.toLocaleString()}
                        </p>
                        <p className="text-xs text-muted-foreground">
                          Principal: ${tx.breakdown?.principal.toFixed(0)}
                        </p>
                      </div>
                    </div>
                  ))}
                </div>
              </Card>
            </div>
          </div>
        )
      }

      const BorrowerPayments = ({ loan, transactions, onMakePayment }) => {
        const myTx = transactions.filter((t) => t.loan_id === loan.id)
        const columns = [
          { key: 'date', label: 'Date' },
          { key: 'type', label: 'Type' },
          {
            key: 'amount',
            label: 'Amount',
            className: 'text-right',
            render: (v) => (
              <span className="font-semibold">${v.toLocaleString()}</span>
            ),
          },
          {
            key: 'breakdown',
            label: 'Principal',
            className: 'text-right',
            render: (v) => `$${v?.principal.toFixed(2)}`,
          },
          {
            key: 'status',
            label: 'Status',
            render: (v) => <Badge variant="success">{v}</Badge>,
          },
        ]
        return (
          <div className="space-y-6">
            <div className="flex items-center justify-between">
              <div>
                <h2 className="text-2xl font-bold">Payment History</h2>
                <p className="text-muted-foreground">
                  View and manage your payments
                </p>
              </div>
              <Button onClick={onMakePayment}>
                <Icon name="credit-card" size={18} />
                Make Payment
              </Button>
            </div>
            <Card className="p-6">
              <div className="flex items-center justify-between mb-4">
                <h3 className="font-semibold">Autopay</h3>
                <div className="flex items-center gap-3">
                  <span className="text-sm text-muted-foreground">
                    Not enrolled
                  </span>
                  <Button variant="outline" size="sm">
                    Set Up Autopay
                  </Button>
                </div>
              </div>
            </Card>
            <Card>
              <DataTable columns={columns} data={myTx} />
            </Card>
          </div>
        )
      }

      const BorrowerDocuments = ({ documents }) => {
        const categories = [
          'All',
          'Statement',
          'Disclosure',
          'Tax',
          'Correspondence',
        ]
        const [activeCategory, setActiveCategory] = useState('All')
        const filtered =
          activeCategory === 'All'
            ? documents
            : documents.filter((d) => d.type === activeCategory)
        return (
          <div className="space-y-6">
            <div className="flex items-center justify-between">
              <div>
                <h2 className="text-2xl font-bold">Documents</h2>
                <p className="text-muted-foreground">
                  Access your loan documents
                </p>
              </div>
              <Button variant="outline">
                <Icon name="file-plus" size={18} />
                Request Document
              </Button>
            </div>
            <Tabs
              tabs={categories.map((c) => ({ id: c, label: c }))}
              activeTab={activeCategory}
              onChange={setActiveCategory}
            />
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {filtered.map((doc) => (
                <Card key={doc.id} hover className="p-4">
                  <div className="flex items-start gap-3">
                    <div className="p-3 rounded-lg bg-muted">
                      <Icon
                        name="file-text"
                        size={24}
                        className="text-muted-foreground"
                      />
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="font-medium text-sm truncate">{doc.name}</p>
                      <p className="text-xs text-muted-foreground">
                        {doc.date}  {doc.size}
                      </p>
                    </div>
                  </div>
                  <div className="flex gap-2 mt-4">
                    <Button variant="ghost" size="sm" className="flex-1">
                      <Icon name="eye" size={16} />
                      View
                    </Button>
                    <Button variant="ghost" size="sm" className="flex-1">
                      <Icon name="download" size={16} />
                      Download
                    </Button>
                  </div>
                </Card>
              ))}
            </div>
          </div>
        )
      }

      const BorrowerEscrow = ({ loan }) => (
        <div className="space-y-6">
          <div>
            <h2 className="text-2xl font-bold">Escrow Account</h2>
            <p className="text-muted-foreground">
              Your taxes and insurance reserve
            </p>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <StatCard
              title="Current Balance"
              value={`$${loan.escrow_balance.toLocaleString()}`}
              icon={{
                name: 'wallet',
                bg: 'bg-emerald-500/10',
                color: 'text-emerald-600',
              }}
            />
            <StatCard
              title="Monthly Deposit"
              value={`$${loan.monthly_escrow.toLocaleString()}`}
              icon={{
                name: 'plus-circle',
                bg: 'bg-blue-500/10',
                color: 'text-blue-600',
              }}
            />
            <StatCard
              title="Annual Analysis"
              value="On Track"
              subtitle="No shortage expected"
              icon={{
                name: 'check-circle',
                bg: 'bg-primary/10',
                color: 'text-primary',
              }}
            />
          </div>
          <Card className="p-6">
            <h3 className="font-bold mb-4">Upcoming Disbursements</h3>
            <div className="space-y-4">
              {[
                {
                  desc: 'Property Tax - Cook County',
                  date: '2024-02-15',
                  amount: 2850,
                },
                {
                  desc: 'Homeowners Insurance',
                  date: '2024-03-01',
                  amount: 1200,
                },
              ].map((item, i) => (
                <div
                  key={i}
                  className="flex items-center justify-between p-4 rounded-lg bg-muted/50"
                >
                  <div className="flex items-center gap-3">
                    <div className="p-2 rounded-lg bg-amber-500/10">
                      <Icon
                        name="calendar"
                        size={18}
                        className="text-amber-600"
                      />
                    </div>
                    <div>
                      <p className="font-medium text-sm">{item.desc}</p>
                      <p className="text-xs text-muted-foreground">
                        {item.date}
                      </p>
                    </div>
                  </div>
                  <span className="font-bold">
                    ${item.amount.toLocaleString()}
                  </span>
                </div>
              ))}
            </div>
          </Card>
        </div>
      )

      const BorrowerMessages = ({ messages }) => (
        <div className="space-y-6">
          <div className="flex items-center justify-between">
            <div>
              <h2 className="text-2xl font-bold">Messages</h2>
              <p className="text-muted-foreground">Contact your servicer</p>
            </div>
            <Button>
              <Icon name="plus" size={18} />
              New Message
            </Button>
          </div>
          <Card className="divide-y">
            {messages.length === 0 ? (
              <EmptyState
                icon="message-square"
                title="No messages"
                description="Start a conversation with your servicer"
                action={<Button variant="outline">Send Message</Button>}
              />
            ) : (
              messages.map((msg) => (
                <div
                  key={msg.id}
                  className="p-4 hover:bg-muted/30 transition-colors cursor-pointer"
                >
                  <div className="flex items-start gap-3">
                    <Avatar
                      name={msg.from === 'borrower' ? 'You' : 'ServState'}
                      size={36}
                    />
                    <div className="flex-1">
                      <div className="flex items-center justify-between">
                        <p className="font-medium text-sm">
                          {msg.from === 'borrower'
                            ? 'You'
                            : 'ServState Support'}
                        </p>
                        <span className="text-xs text-muted-foreground">
                          {msg.date}
                        </span>
                      </div>
                      <p className="text-sm text-muted-foreground mt-1">
                        {msg.content}
                      </p>
                    </div>
                  </div>
                </div>
              ))
            )}
          </Card>
        </div>
      )

      // ============ FULL-SCREEN LOAN DETAIL ============

      const FullScreenLoanDetail = ({ loan, transactions, notes, correspondence, modifications, tasks, onClose, onNavigate, loans }) => {
        const [activeTab, setActiveTab] = useState('overview')
        const loanTx = transactions.filter((t) => t.loan_id === loan.id)
        const loanNotes = notes.filter((n) => n.loan_id === loan.id)
        const loanCorr = correspondence.filter((c) => c.loan_id === loan.id)
        const loanMods = modifications.filter((m) => m.loan_id === loan.id)
        const loanTasks = tasks.filter((t) => t.loan_id === loan.id)

        useEffect(() => {
          const handleKeyPress = (e) => {
            if (e.key === 'Escape') onClose()
            if (e.key === 'ArrowLeft' && onNavigate) onNavigate('prev')
            if (e.key === 'ArrowRight' && onNavigate) onNavigate('next')
          }
          window.addEventListener('keydown', handleKeyPress)
          return () => window.removeEventListener('keydown', handleKeyPress)
        }, [onClose, onNavigate])

        const tabs = [
          { id: 'overview', label: 'Overview', icon: 'layout-dashboard' },
          { id: 'history', label: 'Payment History', icon: 'receipt' },
          { id: 'correspondence', label: 'Correspondence', icon: 'mail', badge: loanCorr.length },
          { id: 'documents', label: 'Documents', icon: 'file-text' },
          { id: 'notes', label: 'Notes', icon: 'sticky-note', badge: loanNotes.length },
          { id: 'modifications', label: 'Modifications', icon: 'settings', badge: loanMods.length },
          { id: 'tasks', label: 'Tasks', icon: 'check-square', badge: loanTasks.length },
          { id: 'escrow', label: 'Escrow', icon: 'piggy-bank' },
        ]

        return (
          <div className="fixed inset-0 z-50 bg-background overflow-hidden animate-in fade-in duration-200">
            {/* Header Bar */}
            <div className="h-16 border-b flex items-center justify-between px-6 glass sticky top-0 z-10 bg-background/95 backdrop-blur">
              <div className="flex items-center gap-4">
                <Button variant="ghost" size="icon" onClick={onClose}>
                  <Icon name="x" size={20} />
                </Button>
                <div>
                  <h2 className="text-lg font-bold">{loan.borrower_name}</h2>
                  <p className="text-sm text-muted-foreground">
                    Loan #{loan.loan_number}  {loan.loan_type}
                  </p>
                </div>
                <div className="flex gap-2">
                  <Badge variant={loan.status === 'Active' ? 'success' : 'destructive'}>
                    {loan.status}
                  </Badge>
                  {loan.days_past_due && (
                    <Badge variant="destructive">{loan.days_past_due}d past due</Badge>
                  )}
                </div>
              </div>

              {/* Navigation & Actions */}
              <div className="flex items-center gap-3">
                {onNavigate && (
                  <>
                    <Button variant="outline" size="sm" onClick={() => onNavigate('prev')}>
                      <Icon name="chevron-left" size={16} />
                      Previous
                    </Button>
                    <Button variant="outline" size="sm" onClick={() => onNavigate('next')}>
                      Next
                      <Icon name="chevron-right" size={16} />
                    </Button>
                    <Separator orientation="vertical" className="h-8" />
                  </>
                )}
                <Button variant="outline" size="sm">
                  <Icon name="printer" size={16} />
                  Print
                </Button>
                <Button size="sm" className="btn-glow">
                  <Icon name="credit-card" size={16} />
                  Take Payment
                </Button>
              </div>
            </div>

            {/* Tab Navigation */}
            <div className="border-b px-6 bg-background/95 backdrop-blur sticky top-16 z-10">
              <div className="flex gap-1 overflow-x-auto">
                {tabs.map((tab) => (
                  <button
                    key={tab.id}
                    onClick={() => setActiveTab(tab.id)}
                    className={`px-4 py-3 text-sm font-medium border-b-2 transition-all flex items-center gap-2 whitespace-nowrap ${
                      activeTab === tab.id
                        ? 'border-primary text-primary'
                        : 'border-transparent text-muted-foreground hover:text-foreground hover:border-muted'
                    }`}
                  >
                    <Icon name={tab.icon} size={16} />
                    {tab.label}
                    {tab.badge > 0 && (
                      <Badge variant="secondary" className="ml-1">{tab.badge}</Badge>
                    )}
                  </button>
                ))}
              </div>
            </div>

            {/* Content Area - Scrollable */}
            <div className="h-[calc(100vh-128px)] overflow-y-auto">
              <div className="p-6">
                {activeTab === 'overview' && (
                  <LoanOverviewTab loan={loan} />
                )}
                {activeTab === 'history' && (
                  <PaymentHistoryTab transactions={loanTx} />
                )}
                {activeTab === 'correspondence' && (
                  <CorrespondenceTab correspondence={loanCorr} loan={loan} />
                )}
                {activeTab === 'documents' && (
                  <DocumentsTab loan={loan} />
                )}
                {activeTab === 'notes' && (
                  <NotesTab notes={loanNotes} loan={loan} />
                )}
                {activeTab === 'modifications' && (
                  <ModificationsTab modifications={loanMods} loan={loan} />
                )}
                {activeTab === 'tasks' && (
                  <LoanTasksTab tasks={loanTasks} loan={loan} />
                )}
                {activeTab === 'escrow' && (
                  <EscrowTab loan={loan} />
                )}
              </div>
            </div>
          </div>
        )
      }

      // Tab Components for Full-Screen Detail

      const LoanOverviewTab = ({ loan }) => (
        <div className="space-y-6">
          {/* Quick Stats Grid */}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <Card className="p-4">
              <p className="text-xs text-muted-foreground uppercase mb-1">Balance</p>
              <p className="text-2xl font-bold">${loan.current_principal.toLocaleString()}</p>
              <p className="text-xs text-muted-foreground mt-1">
                of ${loan.original_principal.toLocaleString()}
              </p>
            </Card>
            <Card className="p-4">
              <p className="text-xs text-muted-foreground uppercase mb-1">Rate</p>
              <p className="text-2xl font-bold">{(loan.interest_rate * 100).toFixed(3)}%</p>
              <p className="text-xs text-muted-foreground mt-1">
                {loan.term_months / 12}-year {loan.loan_type}
              </p>
            </Card>
            <Card className="p-4">
              <p className="text-xs text-muted-foreground uppercase mb-1">Monthly Payment</p>
              <p className="text-2xl font-bold">
                ${(loan.monthly_pi + loan.monthly_escrow).toLocaleString()}
              </p>
              <p className="text-xs text-muted-foreground mt-1">
                PI: ${loan.monthly_pi.toLocaleString()} + Escrow: ${loan.monthly_escrow.toLocaleString()}
              </p>
            </Card>
            <Card className="p-4">
              <p className="text-xs text-muted-foreground uppercase mb-1">Next Due</p>
              <p className="text-2xl font-bold">{loan.next_due_date}</p>
              <p className="text-xs text-muted-foreground mt-1">
                {loan.payments_made} of {loan.term_months} payments made
              </p>
            </Card>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {/* Borrower Contact */}
            <Card className="p-6">
              <h3 className="font-bold text-lg mb-4 flex items-center gap-2">
                <Icon name="user" size={18} />
                Borrower Contact
              </h3>
              <div className="space-y-3">
                <div className="flex items-center gap-3">
                  <Icon name="mail" size={16} className="text-muted-foreground" />
                  <div>
                    <p className="text-sm font-medium">{loan.email}</p>
                    <p className="text-xs text-muted-foreground">Email</p>
                  </div>
                </div>
                <div className="flex items-center gap-3">
                  <Icon name="phone" size={16} className="text-muted-foreground" />
                  <div>
                    <p className="text-sm font-medium">{loan.phone}</p>
                    <p className="text-xs text-muted-foreground">Phone</p>
                  </div>
                </div>
                <div className="flex items-center gap-3">
                  <Icon name="map-pin" size={16} className="text-muted-foreground" />
                  <div>
                    <p className="text-sm font-medium">{loan.address}</p>
                    <p className="text-xs text-muted-foreground">Property Address</p>
                  </div>
                </div>
              </div>
            </Card>

            {/* Loan Details */}
            <Card className="p-6">
              <h3 className="font-bold text-lg mb-4 flex items-center gap-2">
                <Icon name="file-text" size={18} />
                Loan Details
              </h3>
              <div className="space-y-3 text-sm">
                <div className="flex justify-between">
                  <span className="text-muted-foreground">Origination Date</span>
                  <span className="font-medium">{loan.origination_date}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-muted-foreground">Term</span>
                  <span className="font-medium">{loan.term_months} months</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-muted-foreground">Payments Made</span>
                  <span className="font-medium">{loan.payments_made}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-muted-foreground">Escrow Balance</span>
                  <span className="font-medium">${loan.escrow_balance.toLocaleString()}</span>
                </div>
              </div>
            </Card>
          </div>

          {/* Quick Actions */}
          <Card className="p-6">
            <h3 className="font-bold text-lg mb-4">Quick Actions</h3>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
              <Button variant="outline" className="justify-start">
                <Icon name="credit-card" size={16} />
                Take Payment
              </Button>
              <Button variant="outline" className="justify-start">
                <Icon name="phone" size={16} />
                Log Call
              </Button>
              <Button variant="outline" className="justify-start">
                <Icon name="mail" size={16} />
                Send Email
              </Button>
              <Button variant="outline" className="justify-start">
                <Icon name="file-text" size={16} />
                Generate Statement
              </Button>
            </div>
          </Card>
        </div>
      )

      const PaymentHistoryTab = ({ transactions }) => (
        <div className="space-y-4">
          <div className="flex items-center justify-between">
            <h3 className="font-bold text-lg">Payment History</h3>
            <Button variant="outline" size="sm">
              <Icon name="download" size={16} />
              Export
            </Button>
          </div>
          <Card>
            {transactions.length === 0 ? (
              <EmptyState
                icon="receipt"
                title="No transactions"
                description="No payment history available"
              />
            ) : (
              <div className="divide-y">
                {transactions.map((tx) => (
                  <div key={tx.id} className="p-4 hover:bg-muted/50 transition-colors">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="font-medium">{tx.type}</p>
                        <p className="text-sm text-muted-foreground">{tx.date}</p>
                      </div>
                      <div className="text-right">
                        <p className="font-bold text-lg">${tx.amount.toLocaleString()}</p>
                        {tx.breakdown && (
                          <p className="text-xs text-muted-foreground">
                            P: ${tx.breakdown.principal} | I: ${tx.breakdown.interest} | E: ${tx.breakdown.escrow}
                          </p>
                        )}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </Card>
        </div>
      )

      const DocumentsTab = ({ loan }) => (
        <div className="space-y-4">
          <div className="flex items-center justify-between">
            <h3 className="font-bold text-lg">Documents</h3>
            <Button variant="outline" size="sm">
              <Icon name="upload" size={16} />
              Upload
            </Button>
          </div>
          <EmptyState
            icon="file-text"
            title="No documents"
            description="Documents will appear here"
          />
        </div>
      )

      const NotesTab = ({ notes, loan }) => (
        <div className="space-y-4">
          <div className="flex items-center justify-between">
            <h3 className="font-bold text-lg">Internal Notes</h3>
            <Button size="sm">
              <Icon name="plus" size={16} />
              Add Note
            </Button>
          </div>
          <Card>
            {notes.length === 0 ? (
              <EmptyState
                icon="sticky-note"
                title="No notes"
                description="Add the first note for this loan"
              />
            ) : (
              <div className="divide-y">
                {notes.map((note) => (
                  <div key={note.id} className="p-4">
                    <div className="flex items-center justify-between mb-2">
                      <div className="flex items-center gap-2">
                        <Avatar name={note.author} size={28} />
                        <span className="font-medium text-sm">{note.author}</span>
                        <Badge variant="secondary">{note.type}</Badge>
                      </div>
                      <span className="text-xs text-muted-foreground">{note.date}</span>
                    </div>
                    <p className="text-sm">{note.content}</p>
                  </div>
                ))}
              </div>
            )}
          </Card>
        </div>
      )

      const EscrowTab = ({ loan }) => (
        <div className="space-y-6">
          <Card className="p-6">
            <h3 className="font-bold text-lg mb-4">Escrow Account Summary</h3>
            <div className="grid grid-cols-2 gap-6">
              <div>
                <p className="text-sm text-muted-foreground mb-1">Current Balance</p>
                <p className="text-3xl font-bold">${loan.escrow_balance.toLocaleString()}</p>
              </div>
              <div>
                <p className="text-sm text-muted-foreground mb-1">Monthly Deposit</p>
                <p className="text-3xl font-bold">${loan.monthly_escrow.toLocaleString()}</p>
              </div>
            </div>
          </Card>
          <EmptyState
            icon="piggy-bank"
            title="Escrow Details"
            description="Detailed escrow analysis coming soon"
          />
        </div>
      )

      const LoanTasksTab = ({ tasks, loan }) => (
        <div className="space-y-4">
          <div className="flex items-center justify-between">
            <h3 className="font-bold text-lg">Related Tasks</h3>
            <Button size="sm">
              <Icon name="plus" size={16} />
              Create Task
            </Button>
          </div>
          {tasks.length === 0 ? (
            <EmptyState
              icon="check-square"
              title="No tasks"
              description="No tasks for this loan"
            />
          ) : (
            <div className="space-y-3">
              {tasks.map((task) => (
                <Card key={task.id} className={`p-4 border-l-4 ${
                  task.priority === 'high' ? 'border-l-destructive' :
                  task.priority === 'medium' ? 'border-l-amber-500' :
                  'border-l-blue-500'
                }`}>
                  <div className="flex items-start justify-between">
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-1">
                        <Badge variant={
                          task.status === 'completed' ? 'success' :
                          task.status === 'in_progress' ? 'default' :
                          'secondary'
                        }>
                          {task.status.replace('_', ' ')}
                        </Badge>
                        <Badge variant={
                          task.priority === 'high' ? 'destructive' :
                          task.priority === 'medium' ? 'warning' :
                          'outline'
                        }>
                          {task.priority}
                        </Badge>
                        <span className="text-xs text-muted-foreground">{task.category}</span>
                      </div>
                      <h4 className="font-semibold">{task.title}</h4>
                      <p className="text-sm text-muted-foreground mt-1">{task.description}</p>
                      <div className="flex items-center gap-4 mt-2 text-xs text-muted-foreground">
                        <span>Assigned to: {task.assigned_to}</span>
                        <span>Due: {task.due_date}</span>
                      </div>
                    </div>
                    <Button variant="outline" size="sm">View</Button>
                  </div>
                </Card>
              ))}
            </div>
          )}
        </div>
      )

      const CorrespondenceTab = ({ correspondence, loan }) => {
        const [filter, setFilter] = useState('all')
        const [expandedId, setExpandedId] = useState(null)

        const filtered = correspondence.filter((c) => {
          if (filter === 'all') return true
          return c.type === filter
        })

        const getIcon = (type) => {
          const icons = {
            email: { name: 'mail', color: 'text-blue-600' },
            letter: { name: 'file-text', color: 'text-purple-600' },
            sms: { name: 'message-square', color: 'text-green-600' },
            call: { name: 'phone', color: 'text-orange-600' },
          }
          return icons[type] || icons.email
        }

        const getStatusBadge = (item) => {
          if (item.type === 'email') {
            if (item.status === 'opened') return <Badge variant="success">Opened</Badge>
            if (item.status === 'delivered') return <Badge variant="default">Delivered</Badge>
            if (item.status === 'bounced') return <Badge variant="destructive">Bounced</Badge>
          }
          if (item.type === 'letter') {
            if (item.status === 'delivered') return <Badge variant="success">Delivered</Badge>
            if (item.status === 'mailed') return <Badge variant="default">Mailed</Badge>
          }
          if (item.type === 'sms') {
            if (item.status === 'delivered') return <Badge variant="success">Delivered</Badge>
          }
          if (item.type === 'call') {
            if (item.outcome === 'discussed') return <Badge variant="success">Connected</Badge>
            if (item.outcome === 'voicemail') return <Badge variant="warning">Voicemail</Badge>
            if (item.outcome === 'no_answer') return <Badge variant="secondary">No Answer</Badge>
          }
          return null
        }

        return (
          <div className="space-y-4">
            <div className="flex items-center justify-between">
              <h3 className="font-bold text-lg">Communication History</h3>
              <div className="flex items-center gap-2">
                <div className="flex gap-1 p-1 bg-muted rounded-lg">
                  <button
                    onClick={() => setFilter('all')}
                    className={`px-3 py-1.5 text-sm rounded transition-all ${
                      filter === 'all' ? 'bg-background shadow-sm font-medium' : 'text-muted-foreground'
                    }`}
                  >
                    All
                  </button>
                  <button
                    onClick={() => setFilter('email')}
                    className={`px-3 py-1.5 text-sm rounded transition-all ${
                      filter === 'email' ? 'bg-background shadow-sm font-medium' : 'text-muted-foreground'
                    }`}
                  >
                    Emails
                  </button>
                  <button
                    onClick={() => setFilter('call')}
                    className={`px-3 py-1.5 text-sm rounded transition-all ${
                      filter === 'call' ? 'bg-background shadow-sm font-medium' : 'text-muted-foreground'
                    }`}
                  >
                    Calls
                  </button>
                  <button
                    onClick={() => setFilter('letter')}
                    className={`px-3 py-1.5 text-sm rounded transition-all ${
                      filter === 'letter' ? 'bg-background shadow-sm font-medium' : 'text-muted-foreground'
                    }`}
                  >
                    Letters
                  </button>
                  <button
                    onClick={() => setFilter('sms')}
                    className={`px-3 py-1.5 text-sm rounded transition-all ${
                      filter === 'sms' ? 'bg-background shadow-sm font-medium' : 'text-muted-foreground'
                    }`}
                  >
                    SMS
                  </button>
                </div>
                <Button size="sm">
                  <Icon name="send" size={16} />
                  Send Communication
                </Button>
              </div>
            </div>

            {filtered.length === 0 ? (
              <EmptyState
                icon="mail"
                title="No correspondence"
                description="No communication history found"
              />
            ) : (
              <div className="space-y-3">
                {filtered.map((item) => {
                  const icon = getIcon(item.type)
                  const isExpanded = expandedId === item.id
                  return (
                    <Card key={item.id} className="overflow-hidden">
                      <div
                        className="p-4 cursor-pointer hover:bg-muted/50 transition-colors"
                        onClick={() => setExpandedId(isExpanded ? null : item.id)}
                      >
                        <div className="flex items-start justify-between">
                          <div className="flex items-start gap-3 flex-1">
                            <div className={`mt-1 ${icon.color}`}>
                              <Icon name={icon.name} size={20} />
                            </div>
                            <div className="flex-1 min-w-0">
                              <div className="flex items-center gap-2 mb-1">
                                <h4 className="font-semibold truncate">
                                  {item.subject || item.message || `${item.type} - ${item.outcome || 'outbound'}`}
                                </h4>
                                {item.direction === 'inbound' && (
                                  <Badge variant="outline">Inbound</Badge>
                                )}
                              </div>
                              <div className="flex items-center gap-2 text-sm text-muted-foreground">
                                <span>{item.date}</span>
                                <span></span>
                                {item.sent_by && <span>By: {item.sent_by}</span>}
                                {item.agent && <span>Agent: {item.agent}</span>}
                              </div>
                            </div>
                          </div>
                          <div className="flex items-center gap-2 ml-4">
                            {getStatusBadge(item)}
                            <Icon
                              name={isExpanded ? 'chevron-up' : 'chevron-down'}
                              size={20}
                              className="text-muted-foreground"
                            />
                          </div>
                        </div>
                      </div>

                      {isExpanded && (
                        <div className="border-t bg-muted/20 p-4 animate-in slide-in-from-top-2 duration-200">
                          {item.type === 'email' && (
                            <div className="space-y-3">
                              <div className="grid grid-cols-2 gap-3 text-sm">
                                <div>
                                  <span className="text-muted-foreground">From:</span> {item.from}
                                </div>
                                <div>
                                  <span className="text-muted-foreground">To:</span> {item.to}
                                </div>
                              </div>
                              <div className="bg-background p-3 rounded border">
                                <p className="whitespace-pre-wrap text-sm">{item.body}</p>
                              </div>
                              {item.delivery_status && (
                                <div className="flex items-center gap-4 text-xs text-muted-foreground">
                                  <span>Sent: {item.delivery_status.sent}</span>
                                  {item.delivery_status.delivered && <span>Delivered: {item.delivery_status.delivered}</span>}
                                  {item.delivery_status.opened && <span>Opened: {item.delivery_status.opened}</span>}
                                  {item.delivery_status.clicks > 0 && <span>Clicks: {item.delivery_status.clicks}</span>}
                                </div>
                              )}
                              {item.attachments && item.attachments.length > 0 && (
                                <div className="flex items-center gap-2">
                                  <Icon name="paperclip" size={14} className="text-muted-foreground" />
                                  <span className="text-sm text-muted-foreground">
                                    {item.attachments.length} attachment(s)
                                  </span>
                                </div>
                              )}
                            </div>
                          )}
                          {item.type === 'letter' && (
                            <div className="space-y-3">
                              <div className="text-sm">
                                <span className="text-muted-foreground">Mailed to:</span> {item.to_address}
                              </div>
                              {item.tracking_number && (
                                <div className="text-sm">
                                  <span className="text-muted-foreground">Tracking:</span> {item.tracking_number}
                                </div>
                              )}
                              {item.delivery_status && (
                                <div className="flex items-center gap-4 text-xs text-muted-foreground">
                                  <span>Generated: {item.delivery_status.generated}</span>
                                  {item.delivery_status.mailed && <span>Mailed: {item.delivery_status.mailed}</span>}
                                  {item.delivery_status.delivered && <span>Delivered: {item.delivery_status.delivered}</span>}
                                  {item.delivery_status.expected_delivery && <span>Expected: {item.delivery_status.expected_delivery}</span>}
                                </div>
                              )}
                            </div>
                          )}
                          {item.type === 'sms' && (
                            <div className="bg-background p-3 rounded border">
                              <p className="text-sm">{item.message}</p>
                            </div>
                          )}
                          {item.type === 'call' && (
                            <div className="space-y-2">
                              <div className="grid grid-cols-2 gap-3 text-sm">
                                <div>
                                  <span className="text-muted-foreground">Duration:</span> {Math.floor(item.duration / 60)}:{(item.duration % 60).toString().padStart(2, '0')}
                                </div>
                                <div>
                                  <span className="text-muted-foreground">Outcome:</span> {item.outcome}
                                </div>
                              </div>
                              <div className="bg-background p-3 rounded border">
                                <p className="text-sm">{item.notes}</p>
                              </div>
                            </div>
                          )}
                        </div>
                      )}
                    </Card>
                  )
                })}
              </div>
            )}
          </div>
        )
      }

      const ModificationsTab = ({ modifications, loan }) => {
        const [expandedId, setExpandedId] = useState(null)

        const getModIcon = (type) => {
          const icons = {
            payment_plan: 'calendar-check',
            contact_update: 'user-cog',
            fee_adjustment: 'dollar-sign',
            autopay_setup: 'refresh-cw',
            forbearance: 'pause-circle',
            escrow_adjustment: 'piggy-bank',
            late_fee_waiver: 'x-circle',
          }
          return icons[type] || 'settings'
        }

        const getStatusColor = (status) => {
          const colors = {
            active: 'success',
            pending: 'warning',
            completed: 'secondary',
            reversed: 'destructive',
          }
          return colors[status] || 'default'
        }

        return (
          <div className="space-y-4">
            <div className="flex items-center justify-between">
              <h3 className="font-bold text-lg">Account Modifications</h3>
              <Button size="sm">
                <Icon name="plus" size={16} />
                Modify Account
              </Button>
            </div>

            {modifications.length === 0 ? (
              <EmptyState
                icon="settings"
                title="No modifications"
                description="No account changes on record"
              />
            ) : (
              <div className="space-y-3">
                {modifications.map((mod) => {
                  const isExpanded = expandedId === mod.id
                  return (
                    <Card key={mod.id} className="overflow-hidden">
                      <div
                        className="p-4 cursor-pointer hover:bg-muted/50 transition-colors"
                        onClick={() => setExpandedId(isExpanded ? null : mod.id)}
                      >
                        <div className="flex items-start justify-between">
                          <div className="flex items-start gap-3 flex-1">
                            <div className="mt-1">
                              <Icon name={getModIcon(mod.type)} size={20} />
                            </div>
                            <div className="flex-1">
                              <div className="flex items-center gap-2 mb-1">
                                <h4 className="font-semibold">
                                  {mod.type.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')}
                                </h4>
                                <Badge variant={getStatusColor(mod.status)}>
                                  {mod.status}
                                </Badge>
                              </div>
                              <div className="flex items-center gap-2 text-sm text-muted-foreground">
                                <span>{mod.created_date}</span>
                                <span></span>
                                <span>By: {mod.created_by}</span>
                                {mod.effective_date && (
                                  <>
                                    <span></span>
                                    <span>Effective: {mod.effective_date}</span>
                                  </>
                                )}
                              </div>
                            </div>
                          </div>
                          <Icon
                            name={isExpanded ? 'chevron-up' : 'chevron-down'}
                            size={20}
                            className="text-muted-foreground"
                          />
                        </div>
                      </div>

                      {isExpanded && (
                        <div className="border-t bg-muted/20 p-4 animate-in slide-in-from-top-2 duration-200">
                          <div className="space-y-3 text-sm">
                            {Object.entries(mod.details).map(([key, value]) => (
                              <div key={key} className="flex justify-between">
                                <span className="text-muted-foreground">
                                  {key.split(/(?=[A-Z])/).join(' ').charAt(0).toUpperCase() + key.split(/(?=[A-Z])/).join(' ').slice(1)}:
                                </span>
                                <span className="font-medium">
                                  {typeof value === 'number' && key.toLowerCase().includes('amount')
                                    ? `$${value.toLocaleString()}`
                                    : value?.toString()}
                                </span>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}
                    </Card>
                  )
                })}
              </div>
            )}
          </div>
        )
      }

      // ============ TASK MANAGEMENT ============

      const ServicerTasks = ({ tasks, loans, onViewLoan }) => {
        const [statusFilter, setStatusFilter] = useState('all')
        const [priorityFilter, setPriorityFilter] = useState('all')

        const filtered = tasks.filter((task) => {
          if (statusFilter !== 'all' && task.status !== statusFilter) return false
          if (priorityFilter !== 'all' && task.priority !== priorityFilter) return false
          return true
        })

        const pendingCount = tasks.filter(t => t.status === 'pending').length
        const inProgressCount = tasks.filter(t => t.status === 'in_progress').length
        const highPriorityCount = tasks.filter(t => t.priority === 'high' && t.status !== 'completed').length

        return (
          <div className="space-y-6">
            {/* Header */}
            <div className="flex items-center justify-between">
              <div>
                <h2 className="text-2xl font-bold">Task Management</h2>
                <p className="text-muted-foreground">Manage servicing tasks and workflows</p>
              </div>
              <Button className="btn-glow">
                <Icon name="plus" size={16} />
                Create Task
              </Button>
            </div>

            {/* Summary Cards */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <StatCard
                title="Pending Tasks"
                value={pendingCount.toString()}
                subtitle="Awaiting action"
                icon={{ name: 'clock', bg: 'bg-amber-500/10', color: 'text-amber-600' }}
              />
              <StatCard
                title="In Progress"
                value={inProgressCount.toString()}
                subtitle="Currently working"
                icon={{ name: 'loader', bg: 'bg-blue-500/10', color: 'text-blue-600' }}
              />
              <StatCard
                title="High Priority"
                value={highPriorityCount.toString()}
                subtitle="Requires immediate attention"
                icon={{ name: 'alert-circle', bg: 'bg-destructive/10', color: 'text-destructive' }}
              />
            </div>

            {/* Filters */}
            <Card className="p-4">
              <div className="flex flex-wrap items-center gap-4">
                <div className="flex items-center gap-2">
                  <span className="text-sm font-medium">Status:</span>
                  <div className="flex gap-1 p-1 bg-muted rounded-lg">
                    <button
                      onClick={() => setStatusFilter('all')}
                      className={`px-3 py-1.5 text-sm rounded transition-all ${
                        statusFilter === 'all' ? 'bg-background shadow-sm font-medium' : 'text-muted-foreground'
                      }`}
                    >
                      All
                    </button>
                    <button
                      onClick={() => setStatusFilter('pending')}
                      className={`px-3 py-1.5 text-sm rounded transition-all ${
                        statusFilter === 'pending' ? 'bg-background shadow-sm font-medium' : 'text-muted-foreground'
                      }`}
                    >
                      Pending
                    </button>
                    <button
                      onClick={() => setStatusFilter('in_progress')}
                      className={`px-3 py-1.5 text-sm rounded transition-all ${
                        statusFilter === 'in_progress' ? 'bg-background shadow-sm font-medium' : 'text-muted-foreground'
                      }`}
                    >
                      In Progress
                    </button>
                    <button
                      onClick={() => setStatusFilter('completed')}
                      className={`px-3 py-1.5 text-sm rounded transition-all ${
                        statusFilter === 'completed' ? 'bg-background shadow-sm font-medium' : 'text-muted-foreground'
                      }`}
                    >
                      Completed
                    </button>
                  </div>
                </div>

                <Separator orientation="vertical" className="h-6" />

                <div className="flex items-center gap-2">
                  <span className="text-sm font-medium">Priority:</span>
                  <div className="flex gap-1 p-1 bg-muted rounded-lg">
                    <button
                      onClick={() => setPriorityFilter('all')}
                      className={`px-3 py-1.5 text-sm rounded transition-all ${
                        priorityFilter === 'all' ? 'bg-background shadow-sm font-medium' : 'text-muted-foreground'
                      }`}
                    >
                      All
                    </button>
                    <button
                      onClick={() => setPriorityFilter('high')}
                      className={`px-3 py-1.5 text-sm rounded transition-all ${
                        priorityFilter === 'high' ? 'bg-background shadow-sm font-medium' : 'text-muted-foreground'
                      }`}
                    >
                      High
                    </button>
                    <button
                      onClick={() => setPriorityFilter('medium')}
                      className={`px-3 py-1.5 text-sm rounded transition-all ${
                        priorityFilter === 'medium' ? 'bg-background shadow-sm font-medium' : 'text-muted-foreground'
                      }`}
                    >
                      Medium
                    </button>
                    <button
                      onClick={() => setPriorityFilter('low')}
                      className={`px-3 py-1.5 text-sm rounded transition-all ${
                        priorityFilter === 'low' ? 'bg-background shadow-sm font-medium' : 'text-muted-foreground'
                      }`}
                    >
                      Low
                    </button>
                  </div>
                </div>
              </div>
            </Card>

            {/* Task List */}
            {filtered.length === 0 ? (
              <EmptyState
                icon="check-square"
                title="No tasks found"
                description="Try adjusting your filters"
              />
            ) : (
              <div className="space-y-3">
                {filtered.map((task) => (
                  <Card key={task.id} className={`p-4 border-l-4 transition-all hover:shadow-md ${
                    task.priority === 'high' ? 'border-l-destructive' :
                    task.priority === 'medium' ? 'border-l-amber-500' :
                    'border-l-blue-500'
                  }`}>
                    <div className="flex items-start justify-between gap-4">
                      <div className="flex-1 min-w-0">
                        {/* Task Header */}
                        <div className="flex items-center gap-2 mb-2">
                          <Badge variant={
                            task.status === 'completed' ? 'success' :
                            task.status === 'in_progress' ? 'default' :
                            'secondary'
                          }>
                            {task.status.replace('_', ' ')}
                          </Badge>
                          <Badge variant={
                            task.priority === 'high' ? 'destructive' :
                            task.priority === 'medium' ? 'warning' :
                            'outline'
                          }>
                            {task.priority}
                          </Badge>
                          <Badge variant="outline">{task.category}</Badge>
                          {task.completed_date && (
                            <span className="text-xs text-muted-foreground">
                              Completed: {task.completed_date}
                            </span>
                          )}
                        </div>

                        {/* Task Title & Description */}
                        <h3 className="font-semibold text-lg mb-1">{task.title}</h3>
                        <p className="text-sm text-muted-foreground mb-3">{task.description}</p>

                        {/* Task Metadata */}
                        <div className="flex flex-wrap items-center gap-4 text-sm">
                          <div className="flex items-center gap-2">
                            <Icon name="user" size={14} className="text-muted-foreground" />
                            <span className="font-medium">{task.borrower_name}</span>
                            <span className="text-muted-foreground">#{task.loan_number}</span>
                          </div>
                          <div className="flex items-center gap-2">
                            <Icon name="calendar" size={14} className="text-muted-foreground" />
                            <span className="text-muted-foreground">
                              Due: <span className={
                                new Date(task.due_date) < new Date() && task.status !== 'completed'
                                  ? 'text-destructive font-medium'
                                  : 'font-medium'
                              }>{task.due_date}</span>
                            </span>
                          </div>
                          <div className="flex items-center gap-2">
                            <Icon name="users" size={14} className="text-muted-foreground" />
                            <span className="text-muted-foreground">
                              Assigned to: <span className="font-medium">{task.assigned_to}</span>
                            </span>
                          </div>
                        </div>
                      </div>

                      {/* Actions */}
                      <div className="flex flex-col gap-2">
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => onViewLoan && onViewLoan(loans.find(l => l.id === task.loan_id))}
                        >
                          <Icon name="external-link" size={16} />
                          View Loan
                        </Button>
                        {task.status !== 'completed' && (
                          <Button variant="default" size="sm">
                            <Icon name="check" size={16} />
                            Complete
                          </Button>
                        )}
                      </div>
                    </div>
                  </Card>
                ))}
              </div>
            )}
          </div>
        )
      }

      // ============ REPORTS SYSTEM ============

      // Simple Chart Components
      const BarChart = ({ data, labelKey, valueKey, color = 'bg-primary' }) => {
        const maxValue = Math.max(...data.map((d) => d[valueKey]))
        return (
          <div className="space-y-3">
            {data.map((item, idx) => (
              <div key={idx} className="space-y-1">
                <div className="flex justify-between text-sm">
                  <span className="font-medium">{item[labelKey]}</span>
                  <span className="text-muted-foreground">
                    {typeof item[valueKey] === 'number' && item[valueKey] > 1000
                      ? `$${(item[valueKey] / 1000000).toFixed(1)}M`
                      : item[valueKey].toLocaleString()}
                  </span>
                </div>
                <div className="h-2 bg-muted rounded-full overflow-hidden">
                  <div
                    className={`h-full ${color} transition-all duration-500`}
                    style={{ width: `${(item[valueKey] / maxValue) * 100}%` }}
                  />
                </div>
              </div>
            ))}
          </div>
        )
      }

      const LineChart = ({ data, labelKey, valueKey, height = 200 }) => {
        const maxValue = Math.max(...data.map((d) => d[valueKey]))
        const minValue = Math.min(...data.map((d) => d[valueKey]))
        const range = maxValue - minValue
        const points = data.map((item, idx) => {
          const x = (idx / (data.length - 1)) * 100
          const y = 100 - ((item[valueKey] - minValue) / range) * 100
          return `${x},${y}`
        })
        const pathD = `M ${points.join(' L ')}`

        return (
          <div className="space-y-2">
            <svg
              viewBox="0 0 100 100"
              preserveAspectRatio="none"
              style={{ height: `${height}px` }}
              className="w-full"
            >
              <defs>
                <linearGradient id="lineGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                  <stop offset="0%" stopColor="hsl(var(--primary))" stopOpacity="0.3" />
                  <stop offset="100%" stopColor="hsl(var(--primary))" stopOpacity="0.05" />
                </linearGradient>
              </defs>
              <path
                d={`${pathD} L 100,100 L 0,100 Z`}
                fill="url(#lineGradient)"
              />
              <path
                d={pathD}
                fill="none"
                stroke="hsl(var(--primary))"
                strokeWidth="0.5"
                vectorEffect="non-scaling-stroke"
              />
              {data.map((item, idx) => {
                const x = (idx / (data.length - 1)) * 100
                const y = 100 - ((item[valueKey] - minValue) / range) * 100
                return (
                  <circle
                    key={idx}
                    cx={x}
                    cy={y}
                    r="1"
                    fill="hsl(var(--primary))"
                  />
                )
              })}
            </svg>
            <div className="flex justify-between text-xs text-muted-foreground">
              {data.map((item, idx) => (
                <span key={idx}>{item[labelKey]}</span>
              ))}
            </div>
          </div>
        )
      }

      // Report Card Component
      const ReportCard = ({ type, title, description, icon, keyMetric, generatedDate, onClick }) => {
        const colorSchemes = {
          delinquency: { bg: 'bg-red-500/10', text: 'text-red-600', border: 'border-red-200' },
          portfolio: { bg: 'bg-blue-500/10', text: 'text-blue-600', border: 'border-blue-200' },
          paymentActivity: { bg: 'bg-green-500/10', text: 'text-green-600', border: 'border-green-200' },
          escrow: { bg: 'bg-purple-500/10', text: 'text-purple-600', border: 'border-purple-200' },
        }
        const colors = colorSchemes[type] || colorSchemes.portfolio

        return (
          <Card
            className={`p-6 cursor-pointer border-2 ${colors.border} hover:shadow-lg transition-all`}
            onClick={onClick}
          >
            <div className="space-y-4">
              <div className="flex items-start justify-between">
                <div className={`p-3 rounded-lg ${colors.bg}`}>
                  <Icon name={icon} size={24} className={colors.text} />
                </div>
                <Badge variant="outline" className="text-xs">
                  {new Date(generatedDate).toLocaleDateString()}
                </Badge>
              </div>
              <div>
                <h3 className="font-semibold text-lg mb-1">{title}</h3>
                <p className="text-sm text-muted-foreground">{description}</p>
              </div>
              <div className="pt-3 border-t">
                <p className="text-2xl font-bold">{keyMetric}</p>
              </div>
            </div>
          </Card>
        )
      }

      // Report Detail View Component
      const ReportDetailView = ({ reportType, reportData, onBack }) => {
        const renderDelinquencyReport = () => (
          <div className="space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              <StatCard
                title="30+ Days"
                value={reportData.summary.total30Days}
                icon={{ name: 'alert-circle', bg: 'bg-amber-500/10', color: 'text-amber-600' }}
              />
              <StatCard
                title="60+ Days"
                value={reportData.summary.total60Days}
                icon={{ name: 'alert-triangle', bg: 'bg-orange-500/10', color: 'text-orange-600' }}
              />
              <StatCard
                title="90+ Days"
                value={reportData.summary.total90Days}
                icon={{ name: 'alert-octagon', bg: 'bg-destructive/10', color: 'text-destructive' }}
              />
              <StatCard
                title="Total UPB"
                value={`$${(reportData.summary.totalUPB / 1000000).toFixed(1)}M`}
                icon={{ name: 'dollar-sign', bg: 'bg-blue-500/10', color: 'text-blue-600' }}
              />
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <Card className="p-6">
                <h3 className="font-semibold mb-4">Delinquency by Loan Type</h3>
                <BarChart
                  data={reportData.byLoanType}
                  labelKey="type"
                  valueKey="upb"
                  color="bg-red-500"
                />
              </Card>

              <Card className="p-6">
                <h3 className="font-semibold mb-4">Trend (30+ Days)</h3>
                <LineChart
                  data={reportData.trend}
                  labelKey="month"
                  valueKey="count30"
                />
              </Card>
            </div>

            <Card className="p-6">
              <h3 className="font-semibold mb-4">Detailed Breakdown</h3>
              <DataTable
                columns={[
                  { key: 'type', label: 'Loan Type' },
                  { key: 'count30', label: '30+ Days', render: (v) => v || 0 },
                  { key: 'count60', label: '60+ Days', render: (v) => v || 0 },
                  { key: 'count90', label: '90+ Days', render: (v) => v || 0 },
                  { key: 'upb', label: 'Total UPB', render: (v) => `$${v.toLocaleString()}`, className: 'text-right' },
                ]}
                data={reportData.byLoanType}
              />
            </Card>
          </div>
        )

        const renderPortfolioReport = () => (
          <div className="space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              <StatCard
                title="Total Loans"
                value={reportData.summary.totalLoans}
                icon={{ name: 'folder', bg: 'bg-blue-500/10', color: 'text-blue-600' }}
              />
              <StatCard
                title="Total UPB"
                value={`$${(reportData.summary.totalUPB / 1000000).toFixed(1)}M`}
                icon={{ name: 'dollar-sign', bg: 'bg-green-500/10', color: 'text-green-600' }}
              />
              <StatCard
                title="Avg Loan Size"
                value={`$${(reportData.summary.avgLoanSize / 1000).toFixed(0)}K`}
                icon={{ name: 'trending-up', bg: 'bg-purple-500/10', color: 'text-purple-600' }}
              />
              <StatCard
                title="Avg Rate"
                value={`${reportData.summary.avgInterestRate.toFixed(2)}%`}
                icon={{ name: 'percent', bg: 'bg-amber-500/10', color: 'text-amber-600' }}
              />
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <Card className="p-6">
                <h3 className="font-semibold mb-4">By Status</h3>
                <BarChart
                  data={reportData.byStatus}
                  labelKey="status"
                  valueKey="count"
                  color="bg-blue-500"
                />
              </Card>

              <Card className="p-6">
                <h3 className="font-semibold mb-4">By Type</h3>
                <BarChart
                  data={reportData.byType}
                  labelKey="type"
                  valueKey="count"
                  color="bg-purple-500"
                />
              </Card>
            </div>

            <Card className="p-6">
              <h3 className="font-semibold mb-4">By Origination Year</h3>
              <BarChart
                data={reportData.byOriginationYear}
                labelKey="year"
                valueKey="upb"
                color="bg-green-500"
              />
            </Card>
          </div>
        )

        const renderPaymentActivityReport = () => (
          <div className="space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              <StatCard
                title="MTD Collections"
                value={`$${(reportData.summary.mtdCollections / 1000000).toFixed(2)}M`}
                icon={{ name: 'dollar-sign', bg: 'bg-green-500/10', color: 'text-green-600' }}
              />
              <StatCard
                title="YTD Collections"
                value={`$${(reportData.summary.ytdCollections / 1000000).toFixed(1)}M`}
                icon={{ name: 'trending-up', bg: 'bg-blue-500/10', color: 'text-blue-600' }}
              />
              <StatCard
                title="MTD Payments"
                value={reportData.summary.mtdPaymentCount}
                icon={{ name: 'receipt', bg: 'bg-purple-500/10', color: 'text-purple-600' }}
              />
              <StatCard
                title="Collection Rate"
                value={`${reportData.collectionRate.current}%`}
                icon={{ name: 'percent', bg: 'bg-amber-500/10', color: 'text-amber-600' }}
                subtitle={`Target: ${reportData.collectionRate.target}%`}
              />
            </div>

            <Card className="p-6">
              <h3 className="font-semibold mb-4">Monthly Collection Trend</h3>
              <LineChart
                data={reportData.monthlyTrend}
                labelKey="month"
                valueKey="collections"
                height={250}
              />
            </Card>

            <Card className="p-6">
              <h3 className="font-semibold mb-4">Monthly Breakdown</h3>
              <DataTable
                columns={[
                  { key: 'month', label: 'Month' },
                  { key: 'collections', label: 'Collections', render: (v) => `$${v.toLocaleString()}`, className: 'text-right' },
                  { key: 'paymentCount', label: 'Payments', className: 'text-right' },
                  { key: 'lateFees', label: 'Late Fees', render: (v) => `$${v.toLocaleString()}`, className: 'text-right' },
                ]}
                data={reportData.monthlyTrend}
              />
            </Card>
          </div>
        )

        const renderEscrowReport = () => (
          <div className="space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
              <StatCard
                title="Total Balance"
                value={`$${(reportData.summary.totalEscrowBalance / 1000000).toFixed(2)}M`}
                icon={{ name: 'piggy-bank', bg: 'bg-purple-500/10', color: 'text-purple-600' }}
              />
              <StatCard
                title="Loans w/ Escrow"
                value={reportData.summary.loansWithEscrow}
                icon={{ name: 'folder', bg: 'bg-blue-500/10', color: 'text-blue-600' }}
              />
              <StatCard
                title="Shortages"
                value={reportData.summary.shortageAccounts}
                icon={{ name: 'alert-triangle', bg: 'bg-amber-500/10', color: 'text-amber-600' }}
              />
              <StatCard
                title="Surpluses"
                value={reportData.summary.surplusAccounts}
                icon={{ name: 'trending-up', bg: 'bg-green-500/10', color: 'text-green-600' }}
              />
              <StatCard
                title="Avg Cushion"
                value={`$${reportData.summary.avgCushion.toLocaleString()}`}
                icon={{ name: 'dollar-sign', bg: 'bg-purple-500/10', color: 'text-purple-600' }}
              />
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <Card className="p-6">
                <h3 className="font-semibold mb-4 flex items-center gap-2">
                  <Icon name="alert-triangle" size={18} className="text-amber-600" />
                  Shortage Accounts
                </h3>
                <DataTable
                  columns={[
                    { key: 'loanNumber', label: 'Loan #' },
                    { key: 'borrower', label: 'Borrower' },
                    { key: 'shortage', label: 'Amount', render: (v) => `$${v.toLocaleString()}`, className: 'text-right' },
                    { key: 'action', label: 'Action' },
                  ]}
                  data={reportData.shortages.slice(0, 5)}
                />
              </Card>

              <Card className="p-6">
                <h3 className="font-semibold mb-4 flex items-center gap-2">
                  <Icon name="trending-up" size={18} className="text-green-600" />
                  Surplus Accounts
                </h3>
                <DataTable
                  columns={[
                    { key: 'loanNumber', label: 'Loan #' },
                    { key: 'borrower', label: 'Borrower' },
                    { key: 'surplus', label: 'Amount', render: (v) => `$${v.toLocaleString()}`, className: 'text-right' },
                    { key: 'action', label: 'Action' },
                  ]}
                  data={reportData.surpluses}
                />
              </Card>
            </div>
          </div>
        )

        const reportRenderers = {
          delinquency: renderDelinquencyReport,
          portfolio: renderPortfolioReport,
          paymentActivity: renderPaymentActivityReport,
          escrow: renderEscrowReport,
        }

        const reportTitles = {
          delinquency: 'Delinquency Report',
          portfolio: 'Portfolio Summary',
          paymentActivity: 'Payment Activity',
          escrow: 'Escrow Analysis',
        }

        return (
          <div className="space-y-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <Button variant="ghost" size="sm" onClick={onBack}>
                  <Icon name="arrow-left" size={16} />
                </Button>
                <div>
                  <h2 className="text-2xl font-bold">{reportTitles[reportType]}</h2>
                  <p className="text-sm text-muted-foreground">
                    Generated {new Date(reportData.generatedDate).toLocaleDateString()}
                  </p>
                </div>
              </div>
              <div className="flex gap-2">
                <Button variant="outline" size="sm">
                  <Icon name="download" size={16} className="mr-2" />
                  Export PDF
                </Button>
                <Button variant="outline" size="sm">
                  <Icon name="file-spreadsheet" size={16} className="mr-2" />
                  Export Excel
                </Button>
              </div>
            </div>

            {reportRenderers[reportType]()}
          </div>
        )
      }

      // Main ServicerReports Component
      const ServicerReports = ({ reports }) => {
        const [selectedReport, setSelectedReport] = useState(null)

        if (selectedReport) {
          return (
            <ReportDetailView
              reportType={selectedReport}
              reportData={reports[selectedReport]}
              onBack={() => setSelectedReport(null)}
            />
          )
        }

        const reportCards = [
          {
            type: 'delinquency',
            title: 'Delinquency Report',
            description: 'Aging analysis and delinquency trends',
            icon: 'alert-triangle',
            keyMetric: `${reports.delinquency.summary.totalDelinquent} delinquent loans`,
            generatedDate: reports.delinquency.generatedDate,
          },
          {
            type: 'portfolio',
            title: 'Portfolio Summary',
            description: 'Total loans and portfolio composition',
            icon: 'folder',
            keyMetric: `${reports.portfolio.summary.totalLoans} total loans`,
            generatedDate: reports.portfolio.generatedDate,
          },
          {
            type: 'paymentActivity',
            title: 'Payment Activity',
            description: 'Collections and payment performance',
            icon: 'dollar-sign',
            keyMetric: `$${(reports.paymentActivity.summary.mtdCollections / 1000000).toFixed(2)}M MTD`,
            generatedDate: reports.paymentActivity.generatedDate,
          },
          {
            type: 'escrow',
            title: 'Escrow Analysis',
            description: 'Escrow balances and shortages',
            icon: 'piggy-bank',
            keyMetric: `${reports.escrow.summary.loansWithEscrow} loans with escrow`,
            generatedDate: reports.escrow.generatedDate,
          },
        ]

        return (
          <div className="space-y-6">
            <div>
              <h2 className="text-2xl font-bold">Reports</h2>
              <p className="text-muted-foreground">
                View and export mortgage servicing reports
              </p>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              {reportCards.map((card) => (
                <ReportCard
                  key={card.type}
                  {...card}
                  onClick={() => setSelectedReport(card.type)}
                />
              ))}
            </div>
          </div>
        )
      }

      // ============ SERVICER VIEWS ============
      const ServicerDashboard = ({ loans, transactions }) => {
        const totalUPB = loans.reduce((sum, l) => sum + l.current_principal, 0)
        const activeLoans = loans.filter((l) => l.status === 'Active').length
        const delinquent = loans.filter((l) => l.status === 'Delinquent').length
        const mtdCollections = transactions
          .filter((t) => t.date >= '2023-11-01')
          .reduce((sum, t) => sum + t.amount, 0)

        return (
          <div className="space-y-8">
            {/* KPI Cards */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              <StatCard
                title="Total UPB"
                value={`$${(totalUPB / 1000000).toFixed(2)}M`}
                subtitle={`${loans.length} total loans`}
                icon={{
                  name: 'building',
                  bg: 'bg-primary/10',
                  color: 'text-primary',
                }}
                className="animate-in stagger-1"
              />
              <StatCard
                title="Active Loans"
                value={activeLoans}
                trend="+2 this month"
                trendUp
                icon={{
                  name: 'check-circle',
                  bg: 'bg-emerald-500/10',
                  color: 'text-emerald-600',
                }}
                className="animate-in stagger-2"
              />
              <StatCard
                title="Delinquent"
                value={delinquent}
                subtitle={`${((delinquent / loans.length) * 100).toFixed(
                  1
                )}% of portfolio`}
                icon={{
                  name: 'alert-triangle',
                  bg: 'bg-destructive/10',
                  color: 'text-destructive',
                }}
                className="animate-in stagger-3"
              />
              <StatCard
                title="MTD Collections"
                value={`$${mtdCollections.toLocaleString()}`}
                trend="+12.3%"
                trendUp
                icon={{
                  name: 'dollar-sign',
                  bg: 'bg-amber-500/10',
                  color: 'text-amber-600',
                }}
                className="animate-in stagger-4"
              />
            </div>

            {/* Charts Row */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <Card className="p-6 animate-in">
                <h3 className="font-bold text-lg mb-4">
                  Collections vs Disbursements
                </h3>
                <PortfolioChart data={portfolioChartData} />
              </Card>
              <Card className="p-6 animate-in">
                <h3 className="font-bold text-lg mb-4">Portfolio by Status</h3>
                <div className="grid grid-cols-2 gap-4 mt-4">
                  {[
                    {
                      label: 'Active',
                      count: activeLoans,
                      color: 'bg-emerald-500',
                    },
                    {
                      label: 'Delinquent',
                      count: delinquent,
                      color: 'bg-destructive',
                    },
                    {
                      label: 'In Forbearance',
                      count: 0,
                      color: 'bg-amber-500',
                    },
                    { label: 'Paid Off', count: 0, color: 'bg-blue-500' },
                  ].map((item) => (
                    <div
                      key={item.label}
                      className="p-4 rounded-lg bg-muted/50"
                    >
                      <div className="flex items-center gap-2 mb-2">
                        <div className={`w-3 h-3 rounded-full ${item.color}`} />
                        <span className="text-sm font-medium">
                          {item.label}
                        </span>
                      </div>
                      <p className="text-2xl font-bold">{item.count}</p>
                    </div>
                  ))}
                </div>
              </Card>
            </div>

            {/* Recent Activity */}
            <Card className="animate-in">
              <div className="p-6 border-b flex items-center justify-between">
                <h3 className="font-bold text-lg">Recent Transactions</h3>
                <Button variant="ghost" size="sm">
                  View All
                </Button>
              </div>
              <div className="divide-y">
                {transactions.slice(0, 5).map((tx) => {
                  const loan = loans.find((l) => l.id === tx.loan_id)
                  return (
                    <div
                      key={tx.id}
                      className="p-4 flex items-center justify-between hover:bg-muted/30 transition-colors"
                    >
                      <div className="flex items-center gap-3">
                        <Avatar
                          name={loan?.borrower_name || 'Unknown'}
                          size={40}
                        />
                        <div>
                          <p className="font-medium">{loan?.borrower_name}</p>
                          <p className="text-sm text-muted-foreground">
                            {tx.type}  {tx.date}
                          </p>
                        </div>
                      </div>
                      <span className="font-bold text-emerald-600">
                        ${tx.amount.toLocaleString()}
                      </span>
                    </div>
                  )
                })}
              </div>
            </Card>
          </div>
        )
      }

      const ServicerLoans = ({ loans, onSelectLoan }) => {
        const [search, setSearch] = useState('')
        const [statusFilter, setStatusFilter] = useState('')
        const filtered = loans.filter((l) => {
          const matchSearch =
            l.borrower_name.toLowerCase().includes(search.toLowerCase()) ||
            l.loan_number.includes(search)
          const matchStatus = !statusFilter || l.status === statusFilter
          return matchSearch && matchStatus
        })
        const columns = [
          {
            key: 'borrower_name',
            label: 'Borrower',
            render: (v, row) => (
              <div className="flex items-center gap-3">
                <Avatar name={v} size={36} />
                <div>
                  <p className="font-medium">{v}</p>
                  <p className="text-xs text-muted-foreground">
                    {row.loan_number}
                  </p>
                </div>
              </div>
            ),
          },
          {
            key: 'loan_type',
            label: 'Type',
            render: (v) => <Badge variant="secondary">{v}</Badge>,
          },
          {
            key: 'current_principal',
            label: 'Balance',
            className: 'text-right',
            render: (v) => (
              <span className="font-semibold">${v.toLocaleString()}</span>
            ),
          },
          {
            key: 'interest_rate',
            label: 'Rate',
            className: 'text-right',
            render: (v) => `${(v * 100).toFixed(2)}%`,
          },
          { key: 'next_due_date', label: 'Next Due', render: (v) => v },
          {
            key: 'status',
            label: 'Status',
            render: (v, row) => (
              <Badge variant={v === 'Active' ? 'success' : 'destructive'}>
                {v}
                {row.days_past_due ? ` (${row.days_past_due}d)` : ''}
              </Badge>
            ),
          },
        ]
        return (
          <div className="space-y-6">
            <div className="flex items-center justify-between">
              <div>
                <h2 className="text-2xl font-bold">Loan Portfolio</h2>
                <p className="text-muted-foreground">
                  {loans.length} loans  $
                  {(
                    loans.reduce((s, l) => s + l.current_principal, 0) / 1000000
                  ).toFixed(2)}
                  M total UPB
                </p>
              </div>
              <Button>
                <Icon name="plus" size={18} />
                Board New Loan
              </Button>
            </div>
            <Card className="p-4">
              <div className="flex flex-col md:flex-row gap-4">
                <div className="relative flex-1">
                  <Icon
                    name="search"
                    size={18}
                    className="absolute left-3 top-3 text-muted-foreground"
                  />
                  <Input
                    placeholder="Search by name or loan number..."
                    className="pl-10"
                    value={search}
                    onChange={(e) => setSearch(e.target.value)}
                  />
                </div>
                <div className="flex gap-2">
                  {['', 'Active', 'Delinquent'].map((status) => (
                    <Button
                      key={status}
                      variant={statusFilter === status ? 'default' : 'outline'}
                      size="sm"
                      onClick={() => setStatusFilter(status)}
                    >
                      {status || 'All'}
                    </Button>
                  ))}
                </div>
                <Button variant="outline">
                  <Icon name="download" size={18} />
                  Export
                </Button>
              </div>
            </Card>
            <Card>
              <DataTable
                columns={columns}
                data={filtered}
                onRowClick={onSelectLoan}
              />
            </Card>
          </div>
        )
      }

      const ServicerLoanDetail = ({ loan, transactions, notes, onClose }) => {
        const [activeTab, setActiveTab] = useState('overview')
        const loanTx = transactions.filter((t) => t.loan_id === loan.id)
        const loanNotes = notes.filter((n) => n.loan_id === loan.id)
        return (
          <Sheet
            open={true}
            onClose={onClose}
            title={loan.borrower_name}
            width="max-w-2xl"
          >
            <div className="space-y-6">
              {/* Header Info */}
              <div className="flex items-start justify-between">
                <div>
                  <div className="flex items-center gap-2 mb-2">
                    <Badge variant="secondary">{loan.loan_type}</Badge>
                    <Badge
                      variant={
                        loan.status === 'Active' ? 'success' : 'destructive'
                      }
                    >
                      {loan.status}
                    </Badge>
                  </div>
                  <p className="text-sm text-muted-foreground">
                    {loan.address}
                  </p>
                  <p className="text-sm text-muted-foreground">
                    Loan #{loan.loan_number}
                  </p>
                </div>
                <div className="flex gap-2">
                  <Button size="sm">
                    <Icon name="credit-card" size={16} />
                    Take Payment
                  </Button>
                  <Button variant="outline" size="sm">
                    <Icon name="phone" size={16} />
                    Log Contact
                  </Button>
                </div>
              </div>
              <Separator />
              {/* Tabs */}
              <Tabs
                tabs={[
                  { id: 'overview', label: 'Overview' },
                  { id: 'history', label: 'History' },
                  { id: 'notes', label: 'Notes' },
                ]}
                activeTab={activeTab}
                onChange={setActiveTab}
              />
              {/* Tab Content */}
              {activeTab === 'overview' && (
                <div className="grid grid-cols-2 gap-4">
                  <Card className="p-4">
                    <p className="text-xs text-muted-foreground uppercase">
                      Balance
                    </p>
                    <p className="text-2xl font-bold">
                      ${loan.current_principal.toLocaleString()}
                    </p>
                  </Card>
                  <Card className="p-4">
                    <p className="text-xs text-muted-foreground uppercase">
                      Rate
                    </p>
                    <p className="text-2xl font-bold">
                      {(loan.interest_rate * 100).toFixed(3)}%
                    </p>
                  </Card>
                  <Card className="p-4">
                    <p className="text-xs text-muted-foreground uppercase">
                      Monthly Payment
                    </p>
                    <p className="text-2xl font-bold">
                      $
                      {(loan.monthly_pi + loan.monthly_escrow).toLocaleString()}
                    </p>
                  </Card>
                  <Card className="p-4">
                    <p className="text-xs text-muted-foreground uppercase">
                      Next Due
                    </p>
                    <p className="text-2xl font-bold">{loan.next_due_date}</p>
                  </Card>
                  <Card className="p-4 col-span-2">
                    <p className="text-xs text-muted-foreground uppercase mb-2">
                      Contact
                    </p>
                    <div className="flex items-center gap-4">
                      <span className="flex items-center gap-2 text-sm">
                        <Icon
                          name="mail"
                          size={16}
                          className="text-muted-foreground"
                        />
                        {loan.email}
                      </span>
                      <span className="flex items-center gap-2 text-sm">
                        <Icon
                          name="phone"
                          size={16}
                          className="text-muted-foreground"
                        />
                        {loan.phone}
                      </span>
                    </div>
                  </Card>
                </div>
              )}
              {activeTab === 'history' && (
                <div className="space-y-3">
                  {loanTx.map((tx) => (
                    <div
                      key={tx.id}
                      className="flex items-center justify-between p-3 rounded-lg bg-muted/50"
                    >
                      <div>
                        <p className="font-medium text-sm">{tx.type}</p>
                        <p className="text-xs text-muted-foreground">
                          {tx.date}
                        </p>
                      </div>
                      <span className="font-bold">
                        ${tx.amount.toLocaleString()}
                      </span>
                    </div>
                  ))}
                </div>
              )}
              {activeTab === 'notes' && (
                <div className="space-y-4">
                  <Button variant="outline" className="w-full">
                    <Icon name="plus" size={16} />
                    Add Note
                  </Button>
                  {loanNotes.length === 0 ? (
                    <EmptyState
                      icon="sticky-note"
                      title="No notes"
                      description="Add the first note for this loan"
                    />
                  ) : (
                    loanNotes.map((note) => (
                      <Card key={note.id} className="p-4">
                        <div className="flex items-center justify-between mb-2">
                          <div className="flex items-center gap-2">
                            <Avatar name={note.author} size={28} />
                            <span className="font-medium text-sm">
                              {note.author}
                            </span>
                            <Badge variant="secondary">{note.type}</Badge>
                          </div>
                          <span className="text-xs text-muted-foreground">
                            {note.date}
                          </span>
                        </div>
                        <p className="text-sm">{note.content}</p>
                      </Card>
                    ))
                  )}
                </div>
              )}
            </div>
          </Sheet>
        )
      }

      const ServicerDelinquency = ({ loans, onSelectLoan }) => {
        const delinquent = loans
          .filter((l) => l.status === 'Delinquent')
          .sort((a, b) => (b.days_past_due || 0) - (a.days_past_due || 0))
        const columns = [
          {
            key: 'borrower_name',
            label: 'Borrower',
            render: (v, row) => (
              <div className="flex items-center gap-3">
                <Avatar name={v} size={36} />
                <div>
                  <p className="font-medium">{v}</p>
                  <p className="text-xs text-muted-foreground">
                    {row.loan_number}
                  </p>
                </div>
              </div>
            ),
          },
          {
            key: 'days_past_due',
            label: 'Days Past Due',
            render: (v) => (
              <Badge variant={v > 30 ? 'destructive' : 'warning'}>
                {v} days
              </Badge>
            ),
          },
          {
            key: 'current_principal',
            label: 'Balance',
            className: 'text-right',
            render: (v) => `$${v.toLocaleString()}`,
          },
          {
            key: 'monthly_pi',
            label: 'Amount Due',
            className: 'text-right',
            render: (v, row) => `$${(v + row.monthly_escrow).toLocaleString()}`,
          },
          {
            key: 'actions',
            label: '',
            sortable: false,
            render: () => (
              <Button variant="ghost" size="sm">
                <Icon name="phone" size={16} />
              </Button>
            ),
          },
        ]
        return (
          <div className="space-y-6">
            <div>
              <h2 className="text-2xl font-bold">Delinquency Queue</h2>
              <p className="text-muted-foreground">
                {delinquent.length} loans require attention
              </p>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              <StatCard
                title="30+ Days"
                value={delinquent.filter((l) => l.days_past_due >= 30).length}
                icon={{
                  name: 'alert-circle',
                  bg: 'bg-amber-500/10',
                  color: 'text-amber-600',
                }}
              />
              <StatCard
                title="60+ Days"
                value={delinquent.filter((l) => l.days_past_due >= 60).length}
                icon={{
                  name: 'alert-triangle',
                  bg: 'bg-orange-500/10',
                  color: 'text-orange-600',
                }}
              />
              <StatCard
                title="90+ Days"
                value={delinquent.filter((l) => l.days_past_due >= 90).length}
                icon={{
                  name: 'alert-octagon',
                  bg: 'bg-destructive/10',
                  color: 'text-destructive',
                }}
              />
            </div>
            <Card>
              {delinquent.length === 0 ? (
                <EmptyState
                  icon="check-circle"
                  title="No delinquent loans"
                  description="All loans are current"
                />
              ) : (
                <DataTable
                  columns={columns}
                  data={delinquent}
                  onRowClick={onSelectLoan}
                />
              )}
            </Card>
          </div>
        )
      }

      // ============ PAYMENT MODAL ============
      const PaymentModal = ({ open, onClose, loan, onSubmit }) => {
        const [amount, setAmount] = useState(
          (loan?.monthly_pi || 0) + (loan?.monthly_escrow || 0)
        )
        if (!loan) return null
        const totalDue = loan.monthly_pi + loan.monthly_escrow
        const interest = loan.current_principal * (loan.interest_rate / 12)
        const principal = Math.max(0, amount - interest - loan.monthly_escrow)
        return (
          <Modal open={open} onClose={onClose} title="Make a Payment">
            <div className="space-y-6">
              <div>
                <p className="text-sm text-muted-foreground mb-1">
                  Loan #{loan.loan_number}
                </p>
                <p className="font-medium">{loan.borrower_name}</p>
              </div>
              <div className="space-y-2">
                <label className="text-sm font-medium">Payment Amount</label>
                <div className="relative">
                  <span className="absolute left-4 top-3 text-muted-foreground text-lg">
                    $
                  </span>
                  <Input
                    type="number"
                    value={amount}
                    onChange={(e) => setAmount(parseFloat(e.target.value) || 0)}
                    className="pl-8 text-2xl font-bold h-14"
                  />
                </div>
                <p className="text-xs text-muted-foreground">
                  Minimum due: ${totalDue.toLocaleString()}
                </p>
              </div>
              <Card className="p-4 bg-muted/30">
                <p className="text-xs font-semibold uppercase tracking-wider text-muted-foreground mb-3">
                  Payment Allocation
                </p>
                <div className="space-y-2 text-sm">
                  <div className="flex justify-between">
                    <span>Interest</span>
                    <span>${interest.toFixed(2)}</span>
                  </div>
                  <div className="flex justify-between">
                    <span>Escrow</span>
                    <span>${loan.monthly_escrow.toFixed(2)}</span>
                  </div>
                  <Separator />
                  <div className="flex justify-between font-semibold text-primary">
                    <span>To Principal</span>
                    <span>${principal.toFixed(2)}</span>
                  </div>
                </div>
              </Card>
              <div className="flex gap-3">
                <Button variant="outline" className="flex-1" onClick={onClose}>
                  Cancel
                </Button>
                <Button
                  className="flex-1 bg-emerald-600 hover:bg-emerald-700"
                  onClick={() => {
                    onSubmit(loan.id, amount)
                    onClose()
                  }}
                >
                  <Icon name="check" size={18} />
                  Confirm Payment
                </Button>
              </div>
            </div>
          </Modal>
        )
      }

      // ============ MAIN APP ============
      const App = () => {
        const [viewMode, setViewMode] = useState('borrower')
        const [sidebarCollapsed, setSidebarCollapsed] = useState(false)
        const [activeView, setActiveView] = useState('dashboard')
        const [loans, setLoans] = useState(mockLoans)
        const [transactions, setTransactions] = useState(mockTransactions)
        const [tasks, setTasks] = useState(mockTasks)
        const [correspondence, setCorrespondence] = useState(mockCorrespondence)
        const [modifications, setModifications] = useState(mockModifications)
        const [selectedLoan, setSelectedLoan] = useState(null)
        const [fullScreenLoan, setFullScreenLoan] = useState(null)
        const [paymentModal, setPaymentModal] = useState(false)
        const [toast, setToast] = useState(null)

        const currentLoan = loans[0] // For borrower view

        const handleNavigateLoan = (direction) => {
          if (!fullScreenLoan) return
          const currentIndex = loans.findIndex(l => l.id === fullScreenLoan.id)
          if (direction === 'prev' && currentIndex > 0) {
            setFullScreenLoan(loans[currentIndex - 1])
          } else if (direction === 'next' && currentIndex < loans.length - 1) {
            setFullScreenLoan(loans[currentIndex + 1])
          }
        }

        const borrowerNav = [
          { id: 'dashboard', label: 'Dashboard', icon: 'layout-dashboard' },
          { id: 'payments', label: 'Payments', icon: 'credit-card' },
          {
            id: 'documents',
            label: 'Documents',
            icon: 'file-text',
            badge: '3',
          },
          { id: 'escrow', label: 'Escrow', icon: 'piggy-bank' },
          {
            id: 'messages',
            label: 'Messages',
            icon: 'message-circle',
            badge: '1',
            badgeVariant: 'destructive',
          },
        ]

        const pendingTasksCount = tasks.filter(t => t.status === 'pending' || t.status === 'in_progress').length

        const servicerNav = [
          { id: 'dashboard', label: 'Dashboard', icon: 'layout-dashboard' },
          { id: 'loans', label: 'Loans', icon: 'folder' },
          {
            id: 'delinquency',
            label: 'Delinquency',
            icon: 'alert-triangle',
            badge: '2',
            badgeVariant: 'destructive',
          },
          {
            id: 'tasks',
            label: 'Tasks',
            icon: 'check-square',
            badge: pendingTasksCount > 0 ? pendingTasksCount.toString() : null,
            badgeVariant: 'default'
          },
          { id: 'reports', label: 'Reports', icon: 'bar-chart-2' },
        ]

        const processPayment = (loanId, amount) => {
          const loan = loans.find((l) => l.id === loanId)
          const interest = loan.current_principal * (loan.interest_rate / 12)
          const escrow = Math.min(amount - interest, loan.monthly_escrow)
          const principal = Math.max(0, amount - interest - escrow)
          const newTx = {
            id: `tx_${Date.now()}`,
            loan_id: loanId,
            date: new Date().toISOString().split('T')[0],
            type: 'Payment',
            amount,
            breakdown: { principal, interest, escrow },
            status: 'completed',
          }
          setTransactions([newTx, ...transactions])
          setLoans(
            loans.map((l) =>
              l.id === loanId
                ? {
                    ...l,
                    current_principal: l.current_principal - principal,
                    escrow_balance: l.escrow_balance + escrow,
                    payments_made: l.payments_made + 1,
                  }
                : l
            )
          )
          setToast({
            message: `Payment of $${amount.toLocaleString()} processed successfully!`,
            type: 'success',
          })
          setTimeout(() => setToast(null), 4000)
        }

        const navItems = viewMode === 'borrower' ? borrowerNav : servicerNav

        useEffect(() => {
          if (window.lucide) window.lucide.createIcons()
        })

        return (
          <div className="min-h-screen bg-background">
            <Sidebar
              collapsed={sidebarCollapsed}
              setCollapsed={setSidebarCollapsed}
              items={navItems}
              activeItem={activeView}
              onItemClick={setActiveView}
              userType={viewMode}
            />
            <div
              className={`transition-all duration-300 ${
                sidebarCollapsed ? 'ml-[72px]' : 'ml-64'
              }`}
            >
              <Header
                title={
                  navItems.find((n) => n.id === activeView)?.label ||
                  'Dashboard'
                }
                user={{
                  name:
                    viewMode === 'borrower'
                      ? currentLoan.borrower_name
                      : 'Admin User',
                  role: viewMode === 'borrower' ? 'Borrower' : 'Servicer',
                }}
                actions={
                  <div className="flex items-center gap-2 mr-4">
                    <div className="inline-flex h-9 items-center justify-center rounded-lg bg-muted p-1 text-muted-foreground">
                      <button
                        onClick={() => {
                          setViewMode('borrower')
                          setActiveView('dashboard')
                        }}
                        className={`inline-flex items-center justify-center whitespace-nowrap rounded-md px-3 py-1 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 ${
                          viewMode === 'borrower'
                            ? 'bg-background text-foreground shadow'
                            : 'hover:bg-muted/50 hover:text-foreground'
                        }`}
                      >
                        Borrower
                      </button>
                      <button
                        onClick={() => {
                          setViewMode('servicer')
                          setActiveView('dashboard')
                        }}
                        className={`inline-flex items-center justify-center whitespace-nowrap rounded-md px-3 py-1 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 ${
                          viewMode === 'servicer'
                            ? 'bg-background text-foreground shadow'
                            : 'hover:bg-muted/50 hover:text-foreground'
                        }`}
                      >
                        Servicer
                      </button>
                    </div>
                  </div>
                }
              />
              <main className="p-6">
                {viewMode === 'borrower' ? (
                  <>
                    {activeView === 'dashboard' && (
                      <BorrowerDashboard
                        loan={currentLoan}
                        transactions={transactions}
                      />
                    )}
                    {activeView === 'payments' && (
                      <BorrowerPayments
                        loan={currentLoan}
                        transactions={transactions}
                        onMakePayment={() => setPaymentModal(true)}
                      />
                    )}
                    {activeView === 'documents' && (
                      <BorrowerDocuments documents={mockDocuments} />
                    )}
                    {activeView === 'escrow' && (
                      <BorrowerEscrow loan={currentLoan} />
                    )}
                    {activeView === 'messages' && (
                      <BorrowerMessages messages={mockMessages} />
                    )}
                  </>
                ) : (
                  <>
                    {activeView === 'dashboard' && (
                      <ServicerDashboard
                        loans={loans}
                        transactions={transactions}
                      />
                    )}
                    {activeView === 'loans' && (
                      <ServicerLoans
                        loans={loans}
                        onSelectLoan={setFullScreenLoan}
                      />
                    )}
                    {activeView === 'delinquency' && (
                      <ServicerDelinquency
                        loans={loans}
                        onSelectLoan={setFullScreenLoan}
                      />
                    )}
                    {activeView === 'tasks' && (
                      <ServicerTasks
                        tasks={tasks}
                        loans={loans}
                        onViewLoan={setFullScreenLoan}
                      />
                    )}
                    {activeView === 'reports' && (
                      <ServicerReports reports={mockReports} />
                    )}
                  </>
                )}
              </main>
            </div>
            {fullScreenLoan && (
              <FullScreenLoanDetail
                loan={fullScreenLoan}
                transactions={transactions}
                notes={mockNotes}
                correspondence={correspondence}
                modifications={modifications}
                tasks={tasks}
                onClose={() => setFullScreenLoan(null)}
                onNavigate={handleNavigateLoan}
                loans={loans}
              />
            )}
            <PaymentModal
              open={paymentModal}
              onClose={() => setPaymentModal(false)}
              loan={currentLoan}
              onSubmit={processPayment}
            />
            {toast && (
              <Toast
                message={toast.message}
                type={toast.type}
                onClose={() => setToast(null)}
              />
            )}
          </div>
        )
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App />)
    </script>
  </body>
</html>
